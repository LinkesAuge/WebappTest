<!DOCTYPE html>
<!-- Set default language to German -->
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Title will be set by JS -->
    <title>Lade...</title>

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="./icon.png">

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@700&family=Inter:wght@400;600&family=Merriweather:wght@400;700&display=swap" rel="stylesheet">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" integrity="sha512-xh6O/CkQoPOWDdYTDqeRdPCVd1SpvCA9XXcUnZS2FmJNp1coAFzvtCN9BmamE+4aHK8yyUHUSCcJHgXloTyT2A==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <!-- Tailwind CSS via CDN (Note: For production, consider installing Tailwind) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Tailwind Config
        tailwind.config = {
            darkMode: 'class',
            theme: {
                container: { center: true, padding: { DEFAULT: '1rem', sm: '2rem', lg: '4rem', xl: '5rem' } },
                extend: {
                    colors: {
                        background: 'hsl(var(--background))', foreground: 'hsl(var(--foreground))',
                        card: 'hsl(var(--card))', 'card-foreground': 'hsl(var(--card-foreground))',
                        primary: { DEFAULT: 'hsl(var(--primary))', foreground: 'hsl(var(--primary-foreground))' },
                        secondary: { DEFAULT: 'hsl(var(--secondary))', foreground: 'hsl(var(--secondary-foreground))' },
                        border: 'hsl(var(--border))', input: 'hsl(var(--input))', ring: 'hsl(var(--ring))',
                    },
                    fontFamily: {
                        sans: ['Inter', 'ui-sans-serif', 'system-ui', '-apple-system', 'BlinkMacSystemFont', '"Segoe UI"', 'Roboto', '"Helvetica Neue"', 'Arial', '"Noto Sans"', 'sans-serif', '"Apple Color Emoji"', '"Segoe UI Emoji"', '"Segoe UI Symbol"', '"Noto Color Emoji"'],
                        serif: ['Merriweather', 'ui-serif', 'Georgia', 'Cambria', '"Times New Roman"', 'Times', 'serif'],
                        heading: ['"Cinzel Decorative"', 'serif'],
                    },
                    borderRadius: {
                        lg: `var(--radius)`,
                        md: `calc(var(--radius) - 2px)`,
                        sm: "calc(var(--radius) - 4px)",
                    },
                },
            },
            plugins: [],
        };
    </script>
    <style type="text/tailwindcss">
        @layer base {
          :root {
            /* Dark Fantasy Theme Variables */
            --background: 222.2 84% 4.9%;   /* slate-950 */
            --foreground: 210 40% 96.1%; /* slate-200 */
            --card: 222.2 47.4% 11.2%;  /* slate-900 */
            --card-foreground: 210 40% 96.1%; /* slate-200 */
            --primary: 40.7 92.9% 56.1%; /* amber-500 */
            --primary-foreground: 222.2 84% 4.9%; /* slate-950 */
            --secondary: 346.8 77.2% 49.8%; /* rose-600 */
            --secondary-foreground: 355.7 100% 97.3%; /* rose-50 */
            --border: 35.1 70% 45%;   /* amber-600 slightly desaturated */
            --input: 35.1 70% 45%;   /* amber-600 slightly desaturated */
            --ring: 40.7 92.9% 56.1%; /* amber-500 */
            --radius: 0.5rem;
          }
          html { scroll-behavior: smooth; }
          body { @apply bg-background text-foreground font-sans antialiased; font-feature-settings: "rlig" 1, "calt" 1; min-height: 100vh; }
          ::-webkit-scrollbar { width: 10px; height: 10px; }
          ::-webkit-scrollbar-track { background: hsl(var(--background)); }
          ::-webkit-scrollbar-thumb { background: hsl(var(--border)); border-radius: 5px; border: 2px solid hsl(var(--background)); }
          ::-webkit-scrollbar-thumb:hover { background: hsl(var(--primary)); }
          /* Rank Highlights */
          #ranking-table-body tr:nth-child(1) td:nth-child(2)::before { content: 'ðŸ¥‡ '; @apply text-amber-400 inline-block mr-1; }
          #ranking-table-body tr:nth-child(2) td:nth-child(2)::before { content: 'ðŸ¥ˆ '; @apply text-slate-400 inline-block mr-1; }
          #ranking-table-body tr:nth-child(3) td:nth-child(2)::before { content: 'ðŸ¥‰ '; @apply text-orange-500 inline-block mr-1; }
           /* Spinner */
           .spinner { border: 4px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top-color: hsl(var(--primary)); width: 2rem; height: 2rem; animation: spin 1s ease-in-out infinite; margin: 1rem auto; }
           @keyframes spin { to { transform: rotate(360deg); } }
           /* Sticky Header - Needs lower z-index than modal */
            #detailed-table-container thead,
            #ranking-section thead,
            #score-rules-table-container thead,
            #category-analysis-content thead {
                 position: sticky; /* Required for top positioning */
                 top: 0; /* Stick to the top of the container */
                 @apply z-10; /* Keep table headers above table content but below modal */
            }
             /* Focus Visible */
             *:focus-visible { @apply outline-none ring-2 ring-offset-2 ring-offset-background ring-ring; }
             /* Active Nav Link Style */
             .nav-link.active { @apply text-primary border-primary; }
              /* Language Switcher Style */
             .lang-button.active { @apply bg-primary/20 text-primary; }
             /* Chart toolbar styling - Ensure it's above sticky headers but below modal */
             .apexcharts-toolbar { @apply z-20; }
             /* Modal needs highest z-index */
             #chart-modal { @apply z-50; }
        }
    </style>

    <!-- PapaParse CSV Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <!-- ApexCharts Library -->
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

</head>
<body class="bg-background text-foreground font-sans">

    <!-- Header -->
    <header class="bg-card border-b border-border shadow-md sticky top-0 z-30">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between gap-4 h-16">
                <!-- Title and Clan Name -->
                <div class="flex-shrink-0 flex items-center gap-x-3">
                     <!-- Logo -->
                     <img src="./icon_xl.png" alt="Clan Logo" class="h-10 w-10 mr-3"> <!-- Adjusted size -->
                     <!-- App Title -->
                     <h1 class="text-xl sm:text-2xl font-heading font-bold text-primary whitespace-nowrap">
                        <i class="fa-solid fa-treasure-chest mr-2 text-amber-400"></i>
                        <span data-i18n-key="appTitle">Lade Titel...</span>
                     </h1>
                     <!-- Styled Clan Name -->
                     <span class="text-xl sm:text-2xl font-heading font-bold text-primary hidden md:inline" data-i18n-key="clanNameLiteral">- The Chiller</span>
                </div>
                <!-- Main Navigation -->
                 <nav class="hidden md:flex md:items-center md:space-x-4 lg:space-x-6">
                    <a href="#" id="nav-dashboard" class="nav-link text-sm font-medium px-3 py-2 rounded-md border-b-2 border-transparent hover:text-primary hover:border-amber-500/50 transition-colors" data-view="dashboard" data-i18n-key="nav.dashboard">Ãœbersicht</a>
                    <a href="#" id="nav-data" class="nav-link text-sm font-medium px-3 py-2 rounded-md border-b-2 border-transparent hover:text-primary hover:border-amber-500/50 transition-colors" data-view="detailed-table" data-i18n-key="nav.data">Daten</a>
                    <a href="#" id="nav-charts" class="nav-link text-sm font-medium px-3 py-2 rounded-md border-b-2 border-transparent hover:text-primary hover:border-amber-500/50 transition-colors" data-view="charts" data-i18n-key="nav.charts">Diagramme</a>
                    <a href="#" id="nav-analytics" class="nav-link text-sm font-medium px-3 py-2 rounded-md border-b-2 border-transparent hover:text-primary hover:border-amber-500/50 transition-colors" data-view="analytics" data-i18n-key="nav.analytics">Analytik</a>
                    <a href="#" id="nav-score-system" class="nav-link text-sm font-medium px-3 py-2 rounded-md border-b-2 border-transparent hover:text-primary hover:border-amber-500/50 transition-colors" data-view="score-system" data-i18n-key="nav.scoreSystem">Punktesystem</a>
                 </nav>
                 <!-- Header Controls: Language Switcher, CSV Download -->
                <div class="flex items-center gap-3">
                     <div class="flex items-center border border-slate-700 rounded-md text-xs"> <button id="lang-de" class="lang-button px-2 py-1 rounded-l-md hover:bg-slate-700 focus-visible:ring-inset focus-visible:ring-1">DE</button> <span class="bg-slate-700 h-4 w-px"></span> <button id="lang-en" class="lang-button px-2 py-1 rounded-r-md hover:bg-slate-700 focus-visible:ring-inset focus-visible:ring-1">EN</button> </div>
                     <button id="download-csv-header-button" title="Download Processed Data as CSV" class="hidden inline-flex items-center px-3 py-1.5 border border-amber-600 text-amber-600 text-xs font-medium rounded-md hover:bg-amber-900/30 focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-offset-background focus-visible:ring-ring transition-colors duration-150"> <i class="fa-solid fa-file-csv mr-2"></i> <span class="hidden sm:inline" data-i18n-key="button.downloadCsv">Download CSV</span> </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="container mx-auto py-8 px-4 sm:px-6 lg:px-8 space-y-10">

        <!-- Status Area -->
        <div id="status-area" class="text-center py-4 min-h-[2.5rem]" aria-live="polite">
            <div id="loading-spinner" class="hidden spinner"></div>
            <span id="status-message"></span>
        </div>

        <!-- Breadcrumb Navigation -->
        <nav id="breadcrumb-nav" aria-label="Breadcrumb" class="text-sm text-slate-400 hidden mb-6">
            <ol class="inline-flex items-center space-x-1 md:space-x-2">
                <li>
                    <a href="#" id="breadcrumb-dashboard-link" class="inline-flex items-center text-primary hover:underline focus-visible:ring-0 focus-visible:outline-none">
                        <i class="fa-solid fa-table-columns w-4 h-4 mr-2"></i><span data-i18n-key="nav.dashboard">Dashboard</span>
                    </a>
                </li>
                <li id="breadcrumb-current-page-item" aria-current="page">
                    <div class="flex items-center">
                        <i class="fa-solid fa-chevron-right w-3 h-3 text-slate-600 mx-1"></i>
                        <span id="breadcrumb-current-page-name" class="font-medium text-slate-200 ml-1">Current Page</span>
                    </div>
                </li>
            </ol>
        </nav>

        <!-- Empty State Section -->
        <section id="empty-state-section" class="text-center py-16 hidden">
            <i class="fa-solid fa-triangle-exclamation fa-3x text-red-500 mb-4"></i>
            <p class="text-slate-400" data-i18n-key="status.dataLoadError" data-i18n-replacements='{"0": "./data.csv"}'>Could not load analysis data...</p>
        </section>

        <!-- Dashboard Section -->
        <section id="dashboard-section" class="space-y-8 hidden">
            <!-- Section Title -->
            <h2 class="text-xl font-semibold font-serif text-amber-300 border-l-4 border-primary pl-4" data-i18n-key="dashboard.statsTitle">Overall Statistics</h2>

            <!-- Last Updated Info - MOVED & STYLED -->
            <p id="last-updated-info" class="text-sm text-amber-300 font-semibold text-center mb-6"></p>

            <!-- Stats Cards -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-5">
                <div class="bg-card border border-border rounded-lg p-5 shadow-lg flex items-center gap-4">
                    <i class="fa-solid fa-users fa-2x text-sky-500"></i>
                    <div>
                        <div class="text-xs uppercase text-slate-400 tracking-wider" data-i18n-key="dashboard.statPlayers">Players</div>
                        <div id="stat-total-players" class="text-2xl font-bold text-primary mt-1">-</div>
                    </div>
                </div>
                <div class="bg-card border border-border rounded-lg p-5 shadow-lg flex items-center gap-4">
                    <i class="fa-solid fa-star fa-2x text-amber-500"></i>
                    <div>
                        <div class="text-xs uppercase text-slate-400 tracking-wider" data-i18n-key="dashboard.statTotalScore">Total Score</div>
                        <div id="stat-total-score" class="text-2xl font-bold text-primary mt-1">-</div>
                    </div>
                </div>
                <div class="bg-card border border-border rounded-lg p-5 shadow-lg flex items-center gap-4">
                    <i class="fa-solid fa-treasure-chest fa-2x text-orange-500"></i>
                    <div>
                        <div class="text-xs uppercase text-slate-400 tracking-wider" data-i18n-key="dashboard.statTotalChests">Total Chests</div>
                        <div id="stat-total-chests" class="text-2xl font-bold text-primary mt-1">-</div>
                    </div>
                </div>
                <div class="bg-card border border-border rounded-lg p-5 shadow-lg flex items-center gap-4">
                    <i class="fa-solid fa-star-half-stroke fa-2x text-amber-600"></i>
                    <div>
                        <div class="text-xs uppercase text-slate-400 tracking-wider" data-i18n-key="dashboard.statAvgScore">Avg Score</div>
                        <div id="stat-avg-score" class="text-2xl font-bold text-primary mt-1">-</div>
                    </div>
                </div>
                <div class="bg-card border border-border rounded-lg p-5 shadow-lg flex items-center gap-4">
                    <i class="fa-solid fa-box-archive fa-2x text-orange-600"></i>
                    <div>
                        <div class="text-xs uppercase text-slate-400 tracking-wider" data-i18n-key="dashboard.statAvgChests">Avg Chests</div>
                        <div id="stat-avg-chests" class="text-2xl font-bold text-primary mt-1">-</div>
                    </div>
                </div>
            </div>

            <!-- Main Content Grid -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 lg:gap-8">
                <!-- Left Column: Ranking -->
                <div class="lg:col-span-2 space-y-6">
                    <h2 class="text-xl font-semibold font-serif text-amber-300 border-l-4 border-primary pl-4" data-i18n-key="dashboard.rankingTitle">Overall Ranking</h2>
                    <div class="flex flex-col sm:flex-row gap-4">
                        <input type="text" id="filter-input" data-i18n-key="dashboard.filterPlaceholder" placeholder="Filter by Player Name..." class="flex-grow px-3 py-2 bg-slate-700 border border-input rounded-md text-sm text-foreground focus:ring-2 focus:ring-ring focus:border-transparent placeholder-slate-400">
                    </div>
                    <div id="ranking-section" class="overflow-x-auto bg-card border border-border rounded-lg shadow-lg max-h-[65vh]">
                        <table class="min-w-full divide-y divide-slate-700">
                            <thead class="bg-slate-800/75 backdrop-blur-sm sticky top-0 z-10">
                                <tr>
                                    <th scope="col" class="px-4 py-3 text-right text-xs font-medium text-primary uppercase tracking-wider" data-i18n-key="table.headerRank">Rank</th>
                                    <th scope="col" data-column="PLAYER" class="px-6 py-3 text-left text-xs font-medium text-primary uppercase tracking-wider cursor-pointer hover:bg-slate-700 transition-colors duration-150" data-i18n-key="table.headerPlayer">Player <span class="sort-icon inline-block w-3"></span></th>
                                    <th scope="col" data-column="TOTAL_SCORE" class="px-6 py-3 text-right text-xs font-medium text-primary uppercase tracking-wider cursor-pointer hover:bg-slate-700 transition-colors duration-150" data-i18n-key="table.headerTotalScore">Total Score <span class="sort-icon inline-block w-3">â–¼</span></th>
                                    <th scope="col" data-column="CHEST_COUNT" class="px-6 py-3 text-right text-xs font-medium text-primary uppercase tracking-wider cursor-pointer hover:bg-slate-700 transition-colors duration-150" data-i18n-key="table.headerChestCount">Chest Count <span class="sort-icon inline-block w-3"></span></th>
                                </tr>
                            </thead>
                            <tbody id="ranking-table-body" class="divide-y divide-slate-700/50">
                                <tr><td colspan="4" class="text-center py-12 text-slate-500" data-i18n-key="table.noData">No data loaded.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <!-- Right Column: Charts & Widgets -->
                <div class="lg:col-span-1 space-y-6">
                    <div class="bg-card border border-border rounded-lg shadow-lg p-6 relative">
                        <button class="absolute top-2 right-2 p-1 text-slate-400 hover:text-primary focus-visible:ring-0" data-i18n-title-key="button.viewLarger" title="View Larger" data-chart-type="topSources"><i class="fas fa-expand fa-fw"></i></button>
                        <h3 class="text-base font-semibold text-amber-300 mb-3 flex items-center gap-2"><i class="fa-solid fa-sack-dollar text-amber-400"></i> <span data-i18n-key="dashboard.chartTopSourcesTitle">Top Sources by Score</span></h3>
                        <div id="top-sources-chart-container" class="min-h-[280px] flex items-center justify-center"><span class="text-slate-500 text-sm" data-i18n-key="charts.loading">Loading chart...</span></div>
                    </div>
                    <div class="bg-card border border-border rounded-lg shadow-lg p-6 relative">
                        <button class="absolute top-2 right-2 p-1 text-slate-400 hover:text-primary focus-visible:ring-0" data-i18n-title-key="button.viewLarger" title="View Larger" data-chart-type="scoreDistribution"><i class="fas fa-expand fa-fw"></i></button>
                        <h3 class="text-base font-semibold text-amber-300 mb-3 flex items-center gap-2"><i class="fa-solid fa-chart-bar text-sky-400"></i> <span data-i18n-key="dashboard.chartScoreDistTitle">Score Distribution</span></h3>
                        <div id="score-distribution-chart-container" class="min-h-[280px] flex items-center justify-center"><span class="text-slate-500 text-sm" data-i18n-key="charts.loading">Loading chart...</span></div>
                    </div>
                    <div class="bg-card border border-border rounded-lg shadow-lg p-6 relative">
                        <button class="absolute top-2 right-2 p-1 text-slate-400 hover:text-primary focus-visible:ring-0" data-i18n-title-key="button.viewLarger" title="View Larger" data-chart-type="scoreVsChests"><i class="fas fa-expand fa-fw"></i></button>
                        <h3 class="text-base font-semibold text-amber-300 mb-3 flex items-center gap-2"><i class="fa-solid fa-arrows-up-down-left-right text-emerald-400"></i> <span data-i18n-key="dashboard.chartScoreVsChestsTitle">Score vs. Chests</span></h3>
                        <div id="score-vs-chests-chart-container" class="min-h-[280px] flex items-center justify-center"><span class="text-slate-500 text-sm" data-i18n-key="charts.loading">Loading chart...</span></div>
                    </div>
                    <div class="bg-card border border-border rounded-lg shadow-lg p-6 relative">
                        <button class="absolute top-2 right-2 p-1 text-slate-400 hover:text-primary focus-visible:ring-0" data-i18n-title-key="button.viewLarger" title="View Larger" data-chart-type="frequentSources"><i class="fas fa-expand fa-fw"></i></button>
                        <h3 class="text-base font-semibold text-amber-300 mb-3 flex items-center gap-2"><i class="fa-solid fa-boxes-stacked text-orange-400"></i> <span data-i18n-key="dashboard.chartFreqSourcesTitle">Most Frequent Sources</span></h3>
                        <div id="frequent-sources-chart-container" class="min-h-[280px] flex items-center justify-center"><span class="text-slate-500 text-sm" data-i18n-key="charts.loading">Loading chart...</span></div>
                    </div>
                    <div class="bg-card border border-border rounded-lg shadow-lg p-6">
                        <h3 class="text-base font-semibold text-amber-300 mb-3 flex items-center gap-2"><i class="fa-solid fa-box-archive text-orange-600"></i> <span data-i18n-key="dashboard.topChestsTitle">Top 5 by Chest Count</span></h3>
                        <div class="overflow-x-auto max-h-48">
                            <table class="min-w-full text-sm">
                                <thead class="sticky top-0 bg-slate-800/75 backdrop-blur-sm z-10">
                                    <tr>
                                        <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-primary uppercase tracking-wider" data-i18n-key="table.headerPlayer">Player</th>
                                        <th scope="col" class="px-3 py-2 text-right text-xs font-medium text-primary uppercase tracking-wider" data-i18n-key="table.headerChests">Chests</th>
                                    </tr>
                                </thead>
                                <tbody id="top-chests-table-body" class="divide-y divide-slate-700/50">
                                    <tr><td colspan="2" class="text-center py-4 text-slate-500 text-xs" data-i18n-key="table.loading">Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Detailed Table Section -->
        <section id="detailed-table-section" class="space-y-6 hidden">
            <div class="flex flex-wrap justify-between items-center gap-4">
                <h2 class="text-xl font-semibold font-serif text-amber-300 border-l-4 border-primary pl-4" data-i18n-key="detailedTable.title">Full Data Table</h2>
                <button id="back-to-dashboard-from-detailed-table" class="inline-flex items-center px-4 py-1.5 border border-amber-600 text-amber-600 text-xs font-medium rounded-md hover:bg-amber-900/30 focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-offset-background focus-visible:ring-ring transition-colors duration-150"><i class="fa-solid fa-arrow-left mr-2"></i> <span data-i18n-key="nav.dashboard">Dashboard</span></button>
            </div>
            <div id="detailed-table-container" class="overflow-auto bg-card border border-border rounded-lg shadow-lg p-1 max-h-[80vh]">
                <div class="text-center py-12 text-slate-500" data-i18n-key="table.loadingDetailed">Loading detailed table...</div>
            </div>
        </section>

        <!-- Charts Section -->
        <section id="charts-section" class="space-y-8 hidden">
            <h2 class="text-xl font-semibold font-serif text-amber-300 border-l-4 border-primary pl-4" data-i18n-key="charts.title">Charts Overview</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 lg:gap-8">
                <div class="bg-card border border-border rounded-lg shadow-lg p-6 relative">
                    <button class="absolute top-2 right-2 p-1 text-slate-400 hover:text-primary focus-visible:ring-0" data-i18n-title-key="button.viewLarger" title="View Larger" data-chart-type="topSources"><i class="fas fa-expand fa-fw"></i></button>
                    <h3 class="text-base font-semibold text-amber-300 mb-3" data-i18n-key="dashboard.chartTopSourcesTitle">Top Sources by Score</h3>
                    <div id="charts-top-sources-container" class="min-h-[350px]"></div>
                </div>
                <div class="bg-card border border-border rounded-lg shadow-lg p-6 relative">
                     <button class="absolute top-2 right-2 p-1 text-slate-400 hover:text-primary focus-visible:ring-0" data-i18n-title-key="button.viewLarger" title="View Larger" data-chart-type="scoreDistribution"><i class="fas fa-expand fa-fw"></i></button>
                    <h3 class="text-base font-semibold text-amber-300 mb-3" data-i18n-key="dashboard.chartScoreDistTitle">Score Distribution</h3>
                    <div id="charts-distribution-container" class="min-h-[350px]"></div>
                </div>
                <div class="bg-card border border-border rounded-lg shadow-lg p-6 relative">
                     <button class="absolute top-2 right-2 p-1 text-slate-400 hover:text-primary focus-visible:ring-0" data-i18n-title-key="button.viewLarger" title="View Larger" data-chart-type="scoreVsChests"><i class="fas fa-expand fa-fw"></i></button>
                    <h3 class="text-base font-semibold text-amber-300 mb-3" data-i18n-key="dashboard.chartScoreVsChestsTitle">Score vs. Chests</h3>
                    <div id="charts-score-vs-chests-container" class="min-h-[350px]"></div>
                </div>
                <div class="bg-card border border-border rounded-lg shadow-lg p-6 relative">
                     <button class="absolute top-2 right-2 p-1 text-slate-400 hover:text-primary focus-visible:ring-0" data-i18n-title-key="button.viewLarger" title="View Larger" data-chart-type="frequentSources"><i class="fas fa-expand fa-fw"></i></button>
                    <h3 class="text-base font-semibold text-amber-300 mb-3" data-i18n-key="dashboard.chartFreqSourcesTitle">Most Frequent Sources</h3>
                    <div id="charts-frequent-sources-container" class="min-h-[350px]"></div>
                </div>
            </div>
        </section>

        <!-- Analytics Section -->
        <section id="analytics-section" class="space-y-10 hidden">
            <h2 class="text-xl font-semibold font-serif text-amber-300 border-l-4 border-primary pl-4" data-i18n-key="analytics.title">Analytics</h2>
            <div class="flex justify-end">
                <button id="back-to-dashboard-from-analytics" class="inline-flex items-center px-4 py-1.5 border border-amber-600 text-amber-600 text-xs font-medium rounded-md hover:bg-amber-900/30 focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-offset-background focus-visible:ring-ring transition-colors duration-150"><i class="fa-solid fa-arrow-left mr-2"></i> <span data-i18n-key="nav.dashboard">Dashboard</span></button>
            </div>
            <div class="space-y-6 bg-card border border-border rounded-lg shadow-lg p-6">
                <h3 class="text-lg font-semibold text-amber-300" data-i18n-key="analytics.categoryTitle">Category Analysis</h3>
                <div>
                    <label for="category-select" class="block text-sm font-medium text-slate-300 mb-1" data-i18n-key="analytics.selectCategoryLabel">Analyze Category:</label>
                    <select id="category-select" class="w-full sm:max-w-md px-3 py-2 bg-slate-700 border border-input rounded-md text-sm text-foreground focus:ring-2 focus:ring-ring focus:border-transparent">
                        <option value="" data-i18n-key="analytics.selectCategoryDefault">-- Select Category --</option>
                    </select>
                </div>
                <div id="category-analysis-content" class="grid grid-cols-1 md:grid-cols-2 gap-6 lg:gap-8 hidden">
                    <div class="p-0">
                        <h4 class="text-base font-semibold text-amber-300 mb-3"><span data-i18n-key="analytics.topPlayers">Top Players</span>: <span id="category-name-table">[Category Name]</span></h4>
                        <div class="overflow-x-auto max-h-96 border border-slate-700 rounded-md">
                            <table class="min-w-full divide-y divide-slate-700 text-sm">
                                <thead class="bg-slate-800/75 backdrop-blur-sm sticky top-0 z-10">
                                    <tr>
                                        <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-primary uppercase tracking-wider" data-i18n-key="table.headerPlayer">Player</th>
                                        <th scope="col" class="px-4 py-2 text-right text-xs font-medium text-primary uppercase tracking-wider" data-i18n-key="table.headerScore">Score</th>
                                    </tr>
                                </thead>
                                <tbody id="category-ranking-body" class="divide-y divide-slate-700/50">
                                    <tr><td colspan="2" class="text-center py-4 text-slate-500" data-i18n-key="analytics.selectCategoryPrompt">Select a category.</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="p-0">
                        <h4 class="text-base font-semibold text-amber-300 mb-3"><span data-i18n-key="analytics.distribution">Distribution</span>: <span id="category-name-chart">[Category Name]</span></h4>
                        <div id="category-chart-container" class="min-h-[400px] border border-slate-700 rounded-md p-2"></div>
                    </div>
                </div>
                <p id="category-prompt" class="text-slate-400 text-center py-10" data-i18n-key="analytics.selectCategoryPrompt">Select a category from the dropdown above to analyze.</p>
            </div>
            <div class="mt-8 border-t border-slate-700/50 pt-8 space-y-4 bg-card border border-border rounded-lg shadow-lg p-6">
                <h3 class="text-lg font-semibold text-amber-300" data-i18n-key="analytics.playerTitle">Player Analysis</h3>
                <p class="text-slate-400 text-sm mt-2" data-i18n-key="analytics.playerPlaceholder">Further player comparisons or detailed analytics coming soon...</p>
            </div>
            <div class="mt-8 border-t border-slate-700/50 pt-8 space-y-4 bg-card border border-border rounded-lg shadow-lg p-6">
                <h3 class="text-lg font-semibold text-amber-300" data-i18n-key="analytics.clanTitle">Clan Analysis</h3>
                <p class="text-slate-400 text-sm mt-2" data-i18n-key="analytics.clanPlaceholder">Aggregated clan statistics and analytics coming soon...</p>
            </div>
        </section>

        <!-- Score System Section -->
        <section id="score-system-section" class="space-y-6 hidden">
            <h2 class="text-xl font-semibold font-serif text-amber-300 border-l-4 border-primary pl-4" data-i18n-key="scoreSystem.title">Scoring System</h2>
            <div id="score-rules-table-container" class="overflow-auto bg-card border border-border rounded-lg shadow-lg p-1 max-h-[80vh]">
                <div class="text-center py-12 text-slate-500" data-i18n-key="scoreSystem.loading">Loading scoring rules...</div>
            </div>
        </section>

        <!-- Player Detail Section -->
        <section id="detail-section" class="space-y-6 hidden">
            <div class="flex flex-wrap justify-between items-center gap-4">
                <h2 class="text-xl font-semibold font-serif text-amber-300 border-l-4 border-primary pl-4" data-i18n-key="playerDetail.title">Player Details</h2>
                <div class="flex items-center gap-4">
                    <button id="download-player-json-button" data-i18n-title-key="playerDetail.downloadJson" title="Download Player Data as JSON" class="inline-flex items-center px-3 py-1.5 border border-sky-600 text-sky-500 text-xs font-medium rounded-md hover:bg-sky-900/30 focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-offset-background focus-visible:ring-ring transition-colors duration-150"><i class="fa-solid fa-file-code mr-2"></i> <span data-i18n-key="playerDetail.downloadJson">Download JSON</span></button>
                    <button id="back-to-dashboard-from-detail" class="inline-flex items-center px-4 py-1.5 border border-amber-600 text-amber-600 text-xs font-medium rounded-md hover:bg-amber-900/30 focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-offset-background focus-visible:ring-ring transition-colors duration-150"><i class="fa-solid fa-arrow-left mr-2"></i> <span data-i18n-key="nav.dashboard">Dashboard</span></button>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 lg:gap-8">
                <div class="md:col-span-1 bg-card border border-border rounded-lg shadow-lg p-6">
                    <h3 id="player-name-detail" class="text-lg font-semibold text-primary mb-2">[Player Name]</h3>
                    <div class="space-y-2 text-sm">
                        <p><span class="font-medium text-slate-400 w-24 inline-block" data-i18n-key="playerDetail.rank">Rank:</span> <span id="player-rank-detail">[Rank]</span></p>
                        <p><span class="font-medium text-slate-400 w-24 inline-block" data-i18n-key="playerDetail.totalScore">Total Score:</span> <span id="player-score-detail">[Score]</span></p>
                        <p><span class="font-medium text-slate-400 w-24 inline-block" data-i18n-key="playerDetail.totalChests">Total Chests:</span> <span id="player-chests-detail">[Chests]</span></p>
                    </div>
                </div>
                <div class="md:col-span-2 bg-card border border-border rounded-lg shadow-lg p-6">
                    <h3 class="text-base font-semibold text-amber-300 mb-3" data-i18n-key="playerDetail.breakdownTitle">Score Breakdown by Source</h3>
                    <div id="player-breakdown-list" class="max-h-60 overflow-y-auto pr-3 text-sm space-y-1.5">
                        <p class="text-slate-500" data-i18n-key="table.loading">Loading...</p>
                    </div>
                </div>
                <div class="md:col-span-3 bg-card border border-border rounded-lg shadow-lg p-6">
                    <h3 class="text-base font-semibold text-amber-300 mb-3" data-i18n-key="playerDetail.performanceTitle">Top Performance Categories</h3>
                    <div id="player-chart-container" class="min-h-[300px]"></div>
                </div>
            </div>
        </section>

        <!-- Chart Modal -->
        <div id="chart-modal" class="modal hidden fixed inset-0 z-50" aria-labelledby="modal-chart-title" role="dialog" aria-modal="true">
            <div class="fixed inset-0 bg-black/70 backdrop-blur-sm transition-opacity duration-300 ease-out" aria-hidden="true"></div>
            <div class="fixed inset-0 overflow-y-auto">
                <div class="flex min-h-full items-center justify-center p-4 text-center">
                    <div class="relative w-full max-w-4xl transform overflow-hidden rounded-lg bg-card text-left align-middle shadow-xl transition-all border border-border">
                        <div class="flex items-center justify-between p-4 border-b border-slate-700">
                            <h3 id="modal-chart-title" class="text-lg font-medium leading-6 text-primary">Chart Title</h3>
                            <button id="modal-close-button" type="button" class="p-1 rounded-md text-slate-400 hover:text-white hover:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-ring"><span class="sr-only" data-i18n-key="button.close">Close</span><i class="fas fa-times fa-fw"></i></button>
                        </div>
                        <div class="p-6">
                            <div id="modal-chart-container" class="min-h-[60vh]"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- Footer -->
    <footer class="mt-16 py-6 border-t border-slate-800">
        <p class="text-center text-xs text-slate-500">Total Battle Chest Analyzer - Client Side Version (Static Data)</p>
    </footer>

    <!-- Client-Side JavaScript Logic -->
    <script>
        // --- START OF JAVASCRIPT ---
        document.addEventListener('DOMContentLoaded', () => {

            // --- CONFIG ---
            const CSV_FILE_PATH = './data.csv';
            const RULES_CSV_FILE_PATH = './rules.csv';
            const DEFAULT_LANGUAGE = 'de';
            const LANG_STORAGE_KEY = 'tbAnalyzerLanguage';
            const LOCALSTORAGE_DATA_KEY = 'tbAnalyzerStoredData_Client_v2_Static';

            // --- STATE VARIABLES ---
            let allPlayersData = []; let displayData = []; let allColumnHeaders = [];
            let scoreRulesData = []; let currentLanguage = DEFAULT_LANGUAGE; let currentView = 'loading';
            let sortState = { column: 'TOTAL_SCORE', direction: 'desc' };
            let detailedTableSortState = { column: null, direction: 'asc' };
            let scoreRulesSortState = { column: 'Typ', direction: 'asc' };
            let aggregateStats = {}; let currentPlayerData = null;
            let dataLastModifiedTimestamp = null;
            let chartInstances = { player: null, category: null, topSources: null, scoreDistribution: null, scoreVsChests: null, frequentSources: null, modalChart: null };
            let isInitialized = false;
            const CORE_COLUMNS = ['PLAYER', 'TOTAL_SCORE', 'CHEST_COUNT'];
            const NUMERIC_FORMATTER = new Intl.NumberFormat('en-US');

             // --- i18n Text Content ---
             const TEXT_CONTENT = {
                 de: {
                    appTitle: "Truhenauswertung",
                    clanNameLiteral: "- The Chiller",
                    nav: { dashboard: "Ãœbersicht", data: "Daten", charts: "Diagramme", analytics: "Analytik", scoreSystem: "Punktesystem" },
                    button: { downloadCsv: "CSV Herunterladen", viewLarger: "VergrÃ¶ÃŸern", close: "SchlieÃŸen" },
                    dashboard: { statsTitle: "Gesamtstatistik", statPlayers: "Spieler", statTotalScore: "Gesamtpunkte", statTotalChests: "Gesamttruhen", statAvgScore: "Punkte Ã˜", statAvgChests: "Truhen Ã˜", rankingTitle: "Gesamtrangliste", filterPlaceholder: "Spieler filtern...", chartTopSourcesTitle: "Top Quellen (Punkte)", chartScoreDistTitle: "Punkteverteilung", chartScoreVsChestsTitle: "Punkte vs. Truhen", chartFreqSourcesTitle: "HÃ¤ufigste Quellen (Anzahl)", topChestsTitle: "Top 5 (Truhenanzahl)" },
                    charts: { title: "DiagrammÃ¼bersicht", loading: "Lade Diagramm...", othersCategory: "Andere", sourceLabel: "Quelle", notEnoughDataRadar: "Nicht genÃ¼gend Kategoriedaten fÃ¼r Radar-Diagramm (mind. 3).", scopeLabel: "Datenumfang:", scopeOverall: "Gesamt", scopeClan: "Clan (Aggregiert)" },
                    analytics: { title: "Analytik", categoryTitle: "Kategorieanalyse", selectCategoryLabel: "Kategorie auswÃ¤hlen:", selectCategoryDefault: "-- Kategorie wÃ¤hlen --", topPlayers: "Top Spieler", distribution: "Verteilung", selectCategoryPrompt: "Kategorie auswÃ¤hlen fÃ¼r Analyse.", playerTitle: "Spieleranalyse", playerPlaceholder: "Spielervergleiche / Detailanalysen folgen...", clanTitle: "Clananalyse", clanPlaceholder: "Aggregierte Clanstatistiken folgen..." },
                    detailedTable: { title: "Gesamtdatentabelle" },
                    playerDetail: { title: "Spielerdetails", rank: "Rang", totalScore: "Gesamtpunkte", totalChests: "Gesamttruhen", breakdownTitle: "Punkte nach Quelle", performanceTitle: "Top Leistungskategorien", downloadJson: "JSON Herunterladen", noBreakdown: "Keine spezifischen Truhenpunkte vorhanden." },
                    scoreSystem: { title: "Punktesystem", loading: "Lade Punktesystem...", headerTyp: "Typ", headerLevel: "Level", headerPunkte: "Punkte" },
                    table: { headerRank: "Rang", headerPlayer: "Spieler", headerTotalScore: "Gesamtpunkte", headerChestCount: "Truhenanzahl", headerScore: "Punkte", headerChests: "Truhen", noData: "Keine Daten geladen.", noFilterMatch: "Keine Spieler entsprechen dem Filter.", loading: "Lade...", loadingDetailed: "Lade detaillierte Tabelle..." },
                    status: { initializing: "Initialisiere...", loadingData: "Lade Daten von {0}...", parsing: "Verarbeite CSV...", processing: "Verarbeite Daten...", saving: "Speichere Daten...", loadingRules: "Lade Punktesystem von {0}...", success: "Erfolgreich {0} Spieler verarbeitet.", successRules: "Punktesystem geladen.", error: "Fehler", info: "Info", dataLoadError: "Daten konnten nicht geladen werden. Konsole prÃ¼fen oder sicherstellen, dass '{0}' existiert.", parseError: "Fehler beim Parsen von {0}.", processError: "Fehler bei Datenverarbeitung.", renderError: "Fehler bei Anzeige.", kvError: "Fehler beim Speichern/Laden.", genericLoadError: "Fehler beim Laden der Daten: {0}", chartError: "Diagramm konnte nicht geladen werden.", generatingCsv: "Generiere CSV...", downloadInitiated: "{0} Download gestartet.", downloadError: "Fehler beim Generieren von {0} fÃ¼r Download.", generatingJson: "Generiere JSON...", noPlayerData: "Keine Spielerdaten ausgewÃ¤hlt.", lastUpdatedLabel: "Datenstand:", lastUpdatedUnavailable: "Datenstand nicht verfÃ¼gbar" },
                    modal: { close: "SchlieÃŸen" }
                 },
                 en: {
                    appTitle: "Chest Analysis",
                    clanNameLiteral: "- The Chiller",
                    nav: { dashboard: "Dashboard", data: "Data", charts: "Charts", analytics: "Analytics", scoreSystem: "Score System" },
                    button: { downloadCsv: "Download CSV", viewLarger: "View Larger", close: "Close" },
                    dashboard: { statsTitle: "Overall Statistics", statPlayers: "Players", statTotalScore: "Total Score", statTotalChests: "Total Chests", statAvgScore: "Avg Score", statAvgChests: "Avg Chests", rankingTitle: "Overall Ranking", filterPlaceholder: "Filter by Player Name...", chartTopSourcesTitle: "Top Sources by Score", chartScoreDistTitle: "Score Distribution", chartScoreVsChestsTitle: "Score vs. Chests", chartFreqSourcesTitle: "Most Frequent Sources", topChestsTitle: "Top 5 by Chest Count" },
                    charts: { title: "Charts Overview", loading: "Loading chart...", othersCategory: "Others", sourceLabel: "Source", notEnoughDataRadar: "Not enough category data for radar chart (minimum 3).", scopeLabel: "Data Scope:", scopeOverall: "Overall", scopeClan: "Clan (Aggregated)" },
                    analytics: { title: "Analytics", categoryTitle: "Category Analysis", selectCategoryLabel: "Analyze Category:", selectCategoryDefault: "-- Select Category --", topPlayers: "Top Players", distribution: "Distribution", selectCategoryPrompt: "Select a category to analyze.", playerTitle: "Player Analysis", playerPlaceholder: "Player comparisons / detailed analytics coming soon...", clanTitle: "Clan Analysis", clanPlaceholder: "Aggregated clan statistics coming soon..." },
                    detailedTable: { title: "Full Data Table" },
                    playerDetail: { title: "Player Details", rank: "Rank", totalScore: "Total Score", totalChests: "Total Chests", breakdownTitle: "Score Breakdown by Source", performanceTitle: "Top Performance Categories", downloadJson: "Download JSON", noBreakdown: "No specific chest scores recorded." },
                    scoreSystem: { title: "Scoring System", loading: "Loading scoring rules...", headerTyp: "Type", headerLevel: "Level", headerPunkte: "Points" },
                    table: { headerRank: "Rank", headerPlayer: "Player", headerTotalScore: "Total Score", headerChestCount: "Chest Count", headerScore: "Score", headerChests: "Chests", noData: "No data loaded.", noFilterMatch: "No players match the filter.", loading: "Loading...", loadingDetailed: "Loading detailed table..." },
                    status: { initializing: "Initializing...", loadingData: "Loading data from {0}...", parsing: "Parsing CSV...", processing: "Processing data...", saving: "Saving data...", loadingRules: "Loading score system from {0}...", success: "Successfully processed {0} players.", successRules: "Score system loaded.", error: "Error", info: "Info", dataLoadError: "Could not load analysis data. Check console or ensure '{0}' exists.", parseError: "Error parsing {0}.", processError: "Error processing data rows.", renderError: "Error displaying dashboard.", kvError: "Error saving/loading data.", genericLoadError: "Failed to load data: {0}", chartError: "Could not render chart.", generatingCsv: "Generating CSV...", downloadInitiated: "{0} download initiated.", downloadError: "Failed to generate {0} for download.", generatingJson: "Generating JSON...", noPlayerData: "No player data selected.", lastUpdatedLabel: "Data Last Updated:", lastUpdatedUnavailable: "Last updated time unavailable" },
                    modal: { close: "Close" }
                  }
             };

            // --- DOM ELEMENT REFERENCES ---
            function assignElementReferences() { console.log("Assigning DOM Element References..."); statusArea = document.getElementById('status-area'); loadingSpinner = document.getElementById('loading-spinner'); statusMessage = document.getElementById('status-message'); downloadCsvHeaderButton = document.getElementById('download-csv-header-button'); breadcrumbNav = document.getElementById('breadcrumb-nav'); breadcrumbDashboardLink = document.getElementById('breadcrumb-dashboard-link'); breadcrumbCurrentPageItem = document.getElementById('breadcrumb-current-page-item'); breadcrumbCurrentPageName = document.getElementById('breadcrumb-current-page-name'); emptyStateSection = document.getElementById('empty-state-section'); dashboardSection = document.getElementById('dashboard-section'); statTotalPlayers = document.getElementById('stat-total-players'); statTotalScore = document.getElementById('stat-total-score'); statTotalChests = document.getElementById('stat-total-chests'); statAvgScore = document.getElementById('stat-avg-score'); statAvgChests = document.getElementById('stat-avg-chests'); lastUpdatedInfo = document.getElementById('last-updated-info'); topSourcesChartContainer = document.getElementById('top-sources-chart-container'); scoreDistributionChartContainer = document.getElementById('score-distribution-chart-container'); scoreVsChestsChartContainer = document.getElementById('score-vs-chests-chart-container'); frequentSourcesChartContainer = document.getElementById('frequent-sources-chart-container'); topChestsTableBody = document.getElementById('top-chests-table-body'); rankingSection = document.getElementById('ranking-section'); filterInput = document.getElementById('filter-input'); rankingTableBody = document.getElementById('ranking-table-body'); detailedTableSection = document.getElementById('detailed-table-section'); detailedTableContainer = document.getElementById('detailed-table-container'); backToDashboardFromDetailedTable = document.getElementById('back-to-dashboard-from-detailed-table'); chartsSection = document.getElementById('charts-section'); chartsTopSourcesContainer = document.getElementById('charts-top-sources-container'); chartsDistributionContainer = document.getElementById('charts-distribution-container'); chartsScoreVsChestsContainer = document.getElementById('charts-score-vs-chests-container'); chartsFrequentSourcesContainer = document.getElementById('charts-frequent-sources-container'); analyticsSection = document.getElementById('analytics-section'); scoreSystemSection = document.getElementById('score-system-section'); scoreRulesTableContainer = document.getElementById('score-rules-table-container'); detailSection = document.getElementById('detail-section'); backToDashboardFromDetail = document.getElementById('back-to-dashboard-from-detail'); downloadPlayerJsonButton = document.getElementById('download-player-json-button'); playerNameDetail = document.getElementById('player-name-detail'); playerScoreDetail = document.getElementById('player-score-detail'); playerChestsDetail = document.getElementById('player-chests-detail'); playerRankDetail = document.getElementById('player-rank-detail'); playerBreakdownList = document.getElementById('player-breakdown-list'); playerChartContainer = document.getElementById('player-chart-container'); backToDashboardFromAnalytics = document.getElementById('back-to-dashboard-from-analytics'); categorySelect = document.getElementById('category-select'); categoryAnalysisContent = document.getElementById('category-analysis-content'); categoryRankingBody = document.getElementById('category-ranking-body'); categoryNameTable = document.getElementById('category-name-table'); categoryNameChart = document.getElementById('category-name-chart'); categoryChartContainer = document.getElementById('category-chart-container'); categoryPrompt = document.getElementById('category-prompt'); navLinks = document.querySelectorAll('.nav-link'); langDeButton = document.getElementById('lang-de'); langEnButton = document.getElementById('lang-en'); chartModal = document.getElementById('chart-modal'); modalChartTitle = document.getElementById('modal-chart-title'); modalChartContainer = document.getElementById('modal-chart-container'); modalCloseButton = document.getElementById('modal-close-button'); console.log("DOM Element References assigned."); }

            // --- INITIALIZATION ---
             setTimeout(() => { console.log("Starting initialization after timeout..."); try { assignElementReferences(); setupEventListeners(); initializeApp(); console.log("Initialization timeout finished successfully."); } catch (initError) { console.error("CRITICAL ERROR during initialization:", initError); if (statusMessage) { statusMessage.textContent = "Failed to initialize application. Please check the console."; statusArea?.classList.add('text-red-500'); } else { alert("Failed to initialize application. Check console for errors."); } } }, 0);
            async function initializeApp() { console.log("initializeApp started"); isInitialized = false; showLoading(getText("status.initializing")); currentLanguage = getLanguagePreference(); updateLanguageSwitcherUI(); updateUIText(); console.log("Awaiting data load..."); const [dataLoaded, rulesLoaded] = await Promise.all([ loadStaticCsvData(), loadScoreRulesData() ]); console.log(`Data loaded: ${dataLoaded}, Rules loaded: ${rulesLoaded}`); if (dataLoaded) { console.log("Data loaded, processing and switching to dashboard..."); calculateAggregateStats(); populateCategoryDropdown(allColumnHeaders); displayLastUpdatedTimestamp(); renderDashboard(); updateHeaderButtonsVisibility(); switchView('dashboard'); setStatus(getText('status.success', { 0: allPlayersData.length }), 'success', 3000); } else { console.log("Data NOT loaded, updating visibility and switching to empty..."); updateHeaderButtonsVisibility(); switchView('empty'); } hideLoading(); updateUIText(); console.log("initializeApp finished"); isInitialized = true; }

            // --- i18n Functions ---
             function setLanguage(lang) { if (lang === currentLanguage || !TEXT_CONTENT[lang]) return; console.log(`Setting language to: ${lang}`); currentLanguage = lang; localStorage.setItem(LANG_STORAGE_KEY, lang); document.documentElement.lang = lang; updateUIText(); updateLanguageSwitcherUI(); if(allPlayersData.length > 0) { displayLastUpdatedTimestamp(); if (currentView === 'dashboard') renderDashboard(); if(currentView === 'detailed-table') renderDetailedTable(); if(currentView === 'charts') renderChartsView(); if(currentView === 'analytics' && categorySelect?.value) { renderCategoryAnalysis(categorySelect.value); renderCategoryChart(allPlayersData, categorySelect.value); } if(currentView === 'detail' && currentPlayerData) { renderPlayerDetail(currentPlayerData, playerRankDetail?.textContent || 'N/A'); renderPlayerChart(currentPlayerData); } } if(currentView === 'score-system' && scoreRulesData.length > 0) renderScoreRulesTable(); }
             function getLanguagePreference() { return localStorage.getItem(LANG_STORAGE_KEY) || DEFAULT_LANGUAGE; }
             function getText(key, replacements = {}) { const langContent = TEXT_CONTENT[currentLanguage] || TEXT_CONTENT[DEFAULT_LANGUAGE]; let text = key.split('.').reduce((o, i) => o?.[i], langContent); if (text === undefined) { console.warn(`i18n key not found for lang '${currentLanguage}': ${key}`); const defaultContent = TEXT_CONTENT[DEFAULT_LANGUAGE]; text = key.split('.').reduce((o, i) => o?.[i], defaultContent); if(text === undefined) { console.error(`i18n key "${key}" missing in both languages!`); return `[${key}]`; } } Object.entries(replacements).forEach(([rKey, rValue]) => { const placeholder = `{${rKey}}`; text = text.replace(new RegExp(placeholder.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&'), 'g'), String(rValue)); }); return text; }
             function updateUIText() { console.log(`Updating UI text for language: ${currentLanguage}`); document.title = getText('appTitle'); document.querySelectorAll('[data-i18n-key]').forEach(el => { const key = el.dataset.i18nKey; let replacements = {}; if (el.dataset.i18nReplacements) { try { replacements = JSON.parse(el.dataset.i18nReplacements); } catch (e) { console.error(`Invalid JSON in data-i18n-replacements for key '${key}':`, el.dataset.i18nReplacements, e); } } const text = getText(key, replacements); if (key === 'clanNameLiteral') { el.textContent = TEXT_CONTENT[currentLanguage]?.clanNameLiteral || TEXT_CONTENT[DEFAULT_LANGUAGE]?.clanNameLiteral || ''; } else if (el.tagName === 'INPUT' && el.placeholder !== undefined) { el.placeholder = text; } else if (el.tagName === 'OPTION' && el.value === "") { el.textContent = text; } else if (el !== statusMessage && el !== breadcrumbCurrentPageName && el !== lastUpdatedInfo) { el.textContent = text; } else if (el === statusMessage && statusMessage.textContent === '') {} else if (el === breadcrumbCurrentPageName && !breadcrumbNav.classList.contains('hidden') && currentView !== 'detail') { el.textContent = text; } else if (el === lastUpdatedInfo) { displayLastUpdatedTimestamp(); /* Update timestamp text */ } }); document.querySelectorAll('[data-i18n-title-key]').forEach(el => { el.title = getText(el.dataset.i18nTitleKey); }); updateSortIcons(sortState.column, sortState.direction); updateSortIcons(detailedTableSortState.column, detailedTableSortState.direction, '#detailed-table-container thead th[data-column]'); updateSortIcons(scoreRulesSortState.column, scoreRulesSortState.direction, '#score-rules-table-container thead th[data-column]'); }
             function updateLanguageSwitcherUI() { langDeButton?.classList.toggle('active', currentLanguage === 'de'); langEnButton?.classList.toggle('active', currentLanguage === 'en'); }

            // --- EVENT LISTENERS SETUP ---
            function setupEventListeners() { console.log("Setting up event listeners..."); function safeAddListener(element, eventType, handler, elementName) { if (element) { element.addEventListener(eventType, handler); } else { console.error(`Listener Setup Error: Element "${elementName}" not found.`); } } safeAddListener(downloadCsvHeaderButton, 'click', downloadFullDataCSV, 'downloadCsvHeaderButton'); safeAddListener(filterInput, 'input', handleFilter, 'filterInput'); safeAddListener(rankingTableBody, 'click', handleTableRowClick, 'rankingTableBody'); safeAddListener(topChestsTableBody, 'click', handleTableRowClick, 'topChestsTableBody'); const rankingThead = rankingSection ? rankingSection.querySelector('thead') : null; safeAddListener(rankingThead, 'click', handleSortClick, 'Ranking Table Header'); safeAddListener(detailedTableContainer, 'click', handleDetailedTableSortClick, 'Detailed Table Container (for Header)'); safeAddListener(scoreRulesTableContainer, 'click', handleScoreRulesTableSortClick, 'Score Rules Table Container (for Header)'); safeAddListener(breadcrumbDashboardLink, 'click', (e) => { e.preventDefault(); if (!isInitialized) return; switchView('dashboard'); }, 'breadcrumbDashboardLink'); safeAddListener(backToDashboardFromDetail, 'click', () => switchView('dashboard'), 'backToDashboardFromDetail'); safeAddListener(backToDashboardFromDetailedTable, 'click', () => switchView('dashboard'), 'backToDashboardFromDetailedTable'); safeAddListener(backToDashboardFromAnalytics, 'click', () => switchView('dashboard'), 'backToDashboardFromAnalytics'); safeAddListener(downloadPlayerJsonButton, 'click', () => { if (currentPlayerData) { downloadPlayerDataJSON(currentPlayerData); } }, 'downloadPlayerJsonButton'); safeAddListener(categorySelect, 'change', handleCategorySelect, 'categorySelect'); navLinks.forEach(link => { safeAddListener(link, 'click', (e) => { e.preventDefault(); if (!isInitialized) { console.log("Navigation blocked during initialization."); return; } const view = link.dataset.view; if(view) switchView(view); }, `Navbar Link (${link.id || link.dataset.view})`); }); safeAddListener(langDeButton, 'click', () => setLanguage('de'), 'langDeButton'); safeAddListener(langEnButton, 'click', () => setLanguage('en'), 'langEnButton'); safeAddListener(modalCloseButton, 'click', handleModalClose, 'modalCloseButton'); safeAddListener(chartModal, 'click', (e) => { if (e.target === chartModal) handleModalClose(); }, 'chartModalBackdrop'); safeAddListener(dashboardSection, 'click', handleExpandChartClick, 'dashboardSection (for expand buttons)'); safeAddListener(chartsSection, 'click', handleExpandChartClick, 'chartsSection (for expand buttons)'); console.log("Event listeners setup complete."); }

            // --- VIEW MANAGEMENT ---
             function switchView(viewName, contextData = null) { console.log(`Switching view to: ${viewName}`); currentView = viewName; emptyStateSection.classList.add('hidden'); dashboardSection.classList.add('hidden'); detailSection.classList.add('hidden'); analyticsSection.classList.add('hidden'); chartsSection.classList.add('hidden'); scoreSystemSection.classList.add('hidden'); detailedTableSection.classList.add('hidden'); breadcrumbNav.classList.add('hidden'); navLinks.forEach(link => link.classList.remove('active')); let activeNavLinkId = ''; switch(viewName) { case 'dashboard': dashboardSection.classList.remove('hidden'); activeNavLinkId = 'nav-dashboard'; break; case 'detailed-table': activeNavLinkId = 'nav-data'; breadcrumbNav.classList.remove('hidden'); breadcrumbCurrentPageName.textContent = getText('nav.data'); detailedTableSection.classList.remove('hidden'); if(allPlayersData.length > 0) { renderDetailedTable(); } else { setStatus(getText('table.noData'), 'info'); if(detailedTableContainer) detailedTableContainer.innerHTML = `<div class="text-center py-12 text-slate-500">${getText('table.noData')}</div>`; } break; case 'charts': activeNavLinkId = 'nav-charts'; breadcrumbNav.classList.remove('hidden'); breadcrumbCurrentPageName.textContent = getText('nav.charts'); chartsSection.classList.remove('hidden'); if(allPlayersData.length > 0) { renderChartsView(); } else { setStatus(getText('table.noData'), 'info'); if(chartsSection) { chartsSection.innerHTML = `<h2 class="text-xl font-semibold font-serif text-amber-300 border-l-4 border-primary pl-4" data-i18n-key="charts.title">Charts Overview</h2><p class="text-center text-slate-400 py-10">${getText('table.noData')}</p>`; updateUIText(); } } break; case 'analytics': activeNavLinkId = 'nav-analytics'; breadcrumbNav.classList.remove('hidden'); breadcrumbCurrentPageName.textContent = getText('nav.analytics'); analyticsSection.classList.remove('hidden'); if(allPlayersData.length === 0) setStatus(getText('table.noData'), 'info'); break; case 'score-system': activeNavLinkId = 'nav-score-system'; breadcrumbNav.classList.remove('hidden'); breadcrumbCurrentPageName.textContent = getText('nav.scoreSystem'); scoreSystemSection.classList.remove('hidden'); if(scoreRulesData.length > 0) { renderScoreRulesTable(); } else { if(scoreRulesTableContainer) scoreRulesTableContainer.innerHTML = `<div class="text-center py-12 text-slate-500">${getText('scoreSystem.loading')}</div>`; loadScoreRulesData().then(loaded => { if(loaded) renderScoreRulesTable(); else setStatus(getText('scoreSystem.loading') + ' Failed.', 'error');});} break; case 'detail': if (contextData?.playerName) { breadcrumbNav.classList.remove('hidden'); breadcrumbCurrentPageName.textContent = contextData.playerName; detailSection.classList.remove('hidden'); currentPlayerData = allPlayersData.find(p => p.PLAYER === contextData.playerName); activeNavLinkId = ''; } else { console.error("Player name missing for detail view switch."); switchView('dashboard'); } break; case 'empty': emptyStateSection.classList.remove('hidden'); activeNavLinkId = ''; break; case 'chart_modal_active': return; default: console.warn(`Unknown view name: ${viewName}. Switching to dashboard.`); dashboardSection.classList.remove('hidden'); activeNavLinkId = 'nav-dashboard'; break; } const activeLink = document.getElementById(activeNavLinkId); if(activeLink) activeLink.classList.add('active'); if (viewName !== 'detail') { setTimeout(updateUIText, 0); } if (!statusArea?.classList.contains('text-red-500')) { setStatus(''); } if (viewName !== 'chart_modal_active') { window.scrollTo(0, 0); } }

            // --- STATUS/LOADING/ERROR HANDLING ---
            function setStatus(message, type = 'info', duration = 0) { if(!statusMessage || !loadingSpinner || !statusArea) return; loadingSpinner.classList.add('hidden'); statusMessage.textContent = message; statusArea.className = 'text-center py-4 min-h-[2.5rem]'; if (type === 'error') statusArea.classList.add('text-red-500'); else if (type === 'success') statusArea.classList.add('text-green-500'); else statusArea.classList.add('text-slate-400'); if ((type === 'success' || type === 'info') && duration > 0) { setTimeout(() => { if (statusMessage.textContent === message) setStatus(''); }, duration); } }
            function showLoading(message = 'Loading...') { if(!statusMessage || !loadingSpinner) return; setStatus(message, 'info'); loadingSpinner.classList.remove('hidden'); }
            function hideLoading() { if(!statusMessage || !loadingSpinner || !statusArea) return; loadingSpinner.classList.add('hidden'); if (!statusArea.classList.contains('text-red-500')) statusMessage.textContent=''; }

            // --- LOCALSTORAGE FLAG ---
            function saveDataToLocalStorage() { if(allPlayersData.length > 0) { localStorage.setItem(LOCALSTORAGE_DATA_KEY, 'true'); console.log("LocalStorage flag set: Data loaded."); } else { localStorage.removeItem(LOCALSTORAGE_DATA_KEY); console.log("LocalStorage flag removed: No data loaded."); } }
            function loadDataFromLocalStorage() { const flag = localStorage.getItem(LOCALSTORAGE_DATA_KEY) === 'true'; console.log(`LocalStorage flag check: ${flag}`); return flag; }

            // --- DATA TIMESTAMP ---
            function displayLastUpdatedTimestamp() { if (!lastUpdatedInfo) return; if (dataLastModifiedTimestamp) { try { const date = new Date(dataLastModifiedTimestamp); if (isNaN(date.getTime())) throw new Error("Invalid Date parsed from header"); const options = { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }; const formattedDate = new Intl.DateTimeFormat(currentLanguage, options).format(date); lastUpdatedInfo.textContent = `${getText('status.lastUpdatedLabel')} ${formattedDate}`; } catch (error) { console.error("Error formatting Last-Modified timestamp:", error); lastUpdatedInfo.textContent = getText('status.lastUpdatedUnavailable'); } } else { lastUpdatedInfo.textContent = getText('status.lastUpdatedUnavailable'); } }

            // --- STATIC CSV LOADING & PARSING ---
             async function loadStaticCsvData() { console.log(`Fetching static CSV: ${CSV_FILE_PATH}`); showLoading(getText('status.loadingData', {0: CSV_FILE_PATH})); dataLastModifiedTimestamp = null; try { const cacheBuster = `?t=${Date.now()}`; const response = await fetch(`${CSV_FILE_PATH}${cacheBuster}`); if (!response.ok) throw new Error(`HTTP error ${response.status}`); dataLastModifiedTimestamp = response.headers.get('Last-Modified'); if (dataLastModifiedTimestamp) console.log(`Got Last-Modified header: ${dataLastModifiedTimestamp}`); else console.warn('Last-Modified header not found in response.'); const csvText = await response.text(); console.log(`Fetched CSV text (first 500 chars): ${csvText.substring(0, 500)}...`); showLoading(getText('status.parsing')); return new Promise((resolve) => { Papa.parse(csvText, { header: true, skipEmptyLines: true, dynamicTyping: false, complete: (results) => { console.log('PapaParse complete for static CSV.'); if (results.errors.length > 0 || !results.data || results.data.length === 0 || !results.meta.fields || !results.meta.fields.includes('PLAYER') || !results.meta.fields.includes('TOTAL_SCORE')) { console.error('Static CSV parsing errors or invalid structure:', results.errors); setStatus(getText('status.parseError', {0: CSV_FILE_PATH}), 'error', 5000); resetStateAndUI(); resolve(false); return; } allColumnHeaders = results.meta.fields; showLoading(getText('status.processing')); try { allPlayersData = results.data.map((player) => { const cleanedPlayer = {}; allColumnHeaders.forEach(key => { let value = player[key]; if (key === 'PLAYER') cleanedPlayer[key] = String(value || '').trim(); else if (value !== undefined && value !== null && value !== '') { const num = Number(String(value).replace(/,/g, '')); cleanedPlayer[key] = !isNaN(num) && isFinite(num) ? num : 0; } else cleanedPlayer[key] = 0; }); cleanedPlayer.TOTAL_SCORE = cleanedPlayer.TOTAL_SCORE || 0; cleanedPlayer.CHEST_COUNT = cleanedPlayer.CHEST_COUNT || 0; return cleanedPlayer; }).filter(p => p.PLAYER); } catch (mapError) { console.error('Error during data mapping/cleaning:', mapError); setStatus(getText('status.processError'), 'error', 5000); resetStateAndUI(); resolve(false); return; } console.log(`Cleaned data rows: ${allPlayersData.length}.`); if (allPlayersData.length === 0) { console.warn('No valid player data found after cleaning.'); setStatus(getText('status.processError') + " (No valid rows)", 'error', 5000); resetStateAndUI(); resolve(false); return; } displayData = [...allPlayersData]; try { saveDataToLocalStorage(); console.log('Static data processed successfully.'); resolve(true); } catch (processError) { console.error('Error during post-processing setup (e.g., localStorage):', processError); setStatus(getText('status.renderError'), 'error', 5000); resetStateAndUI(); resolve(false); } }, error: (error) => { console.error('PapaParse failed for static CSV:', error); setStatus(getText('status.parseError', {0: CSV_FILE_PATH}), 'error', 5000); resetStateAndUI(); resolve(false); } }); }); } catch (error) { console.error('Failed to fetch or process static CSV:', error); setStatus(getText('status.dataLoadError', {0: CSV_FILE_PATH}), 'error', 5000); resetStateAndUI(); return false; } }

            // --- SCORE SYSTEM DATA LOADING ---
             async function loadScoreRulesData() { if (scoreRulesData.length > 0) return true; console.log(`Fetching score rules CSV: ${RULES_CSV_FILE_PATH}`); try { const cacheBuster = `?t=${Date.now()}`; const response = await fetch(`${RULES_CSV_FILE_PATH}${cacheBuster}`); if (!response.ok) throw new Error(`HTTP error ${response.status}`); const csvText = await response.text(); return new Promise((resolve) => { Papa.parse(csvText, { header: true, skipEmptyLines: true, dynamicTyping: false, complete: (results) => { if (results.errors.length > 0 || !results.data) { console.error('Score rules CSV parsing errors:', results.errors); setStatus(getText('status.parseError', {0: RULES_CSV_FILE_PATH}), 'error', 5000); resolve(false); return; } scoreRulesData = results.data.map(row => ({ Typ: String(row.Typ || '').trim(), Level: Number(row.Level) || 0, Punkte: Number(row.Punkte) || 0 })); console.log(`Loaded ${scoreRulesData.length} score rules.`); resolve(true); }, error: (error) => { console.error('PapaParse failed for rules CSV:', error); setStatus(getText('status.parseError', {0: RULES_CSV_FILE_PATH}), 'error', 5000); resolve(false); } }); }); } catch (error) { console.error('Failed to fetch or process rules CSV:', error); setStatus(getText('status.genericLoadError', {0: error.message}), 'error', 5000); return false; } }

            // --- RESET & UPDATE UI ---
            function resetStateAndUI() { console.log("Resetting state and UI..."); allPlayersData = []; displayData = []; allColumnHeaders = []; currentPlayerData = null; aggregateStats = {}; dataLastModifiedTimestamp = null; resetDashboardUI(); updateHeaderButtonsVisibility(); if(detailedTableContainer) detailedTableContainer.innerHTML = `<div class="text-center py-12 text-slate-500">${getText('table.noData')}</div>`; if(scoreRulesTableContainer) scoreRulesTableContainer.innerHTML = `<div class="text-center py-12 text-slate-500">${getText('scoreSystem.loading')}</div>`; if(categoryRankingBody) categoryRankingBody.innerHTML = `<tr><td colspan="2" class="text-center py-4 text-slate-500">${getText('analytics.selectCategoryPrompt')}</td></tr>`; if(categorySelect) categorySelect.length = 1; if(categoryAnalysisContent) categoryAnalysisContent.classList.add('hidden'); if(categoryPrompt) categoryPrompt.classList.remove('hidden'); if(playerBreakdownList) playerBreakdownList.innerHTML = `<p class="text-slate-500">${getText('table.loading')}</p>`; if(playerNameDetail) playerNameDetail.textContent = '[Player Name]'; if(playerScoreDetail) playerScoreDetail.textContent = '[Score]'; if(playerChestsDetail) playerChestsDetail.textContent = '[Chests]'; if(playerRankDetail) playerRankDetail.textContent = '[Rank]'; if(filterInput) filterInput.value = ''; sortState = { column: 'TOTAL_SCORE', direction: 'desc' }; detailedTableSortState = { column: null, direction: 'asc' }; scoreRulesSortState = { column: 'Typ', direction: 'asc' }; Object.keys(chartInstances).forEach(key => { if (chartInstances[key]) { try { chartInstances[key].destroy(); } catch (e) {console.warn(`Error destroying chart ${key}:`, e)} chartInstances[key] = null; } }); [topSourcesChartContainer, scoreDistributionChartContainer, scoreVsChestsChartContainer, frequentSourcesChartContainer, playerChartContainer, categoryChartContainer, modalChartContainer, chartsTopSourcesContainer, chartsDistributionContainer, chartsScoreVsChestsContainer, chartsFrequentSourcesContainer].forEach(c => { if(c) c.innerHTML = ''; }); if(lastUpdatedInfo) lastUpdatedInfo.textContent = ''; console.log("State and UI reset complete."); }
            function updateHeaderButtonsVisibility() { if(downloadCsvHeaderButton) downloadCsvHeaderButton.classList.toggle('hidden', allPlayersData.length === 0); }
            function resetDashboardUI() { console.log("Resetting Dashboard UI elements..."); if(statTotalPlayers) statTotalPlayers.textContent = '-'; if(statTotalScore) statTotalScore.textContent = '-'; if(statTotalChests) statTotalChests.textContent = '-'; if(statAvgScore) statAvgScore.textContent = '-'; if(statAvgChests) statAvgChests.textContent = '-'; if(rankingTableBody) rankingTableBody.innerHTML = `<tr><td colspan="4" class="text-center py-12 text-slate-500">${getText('table.noData')}</td></tr>`; if(topChestsTableBody) topChestsTableBody.innerHTML = `<tr><td colspan="2" class="text-center py-4 text-slate-500 text-xs">${getText('table.noData')}</td></tr>`; if(lastUpdatedInfo) lastUpdatedInfo.textContent = ''; console.log("Dashboard UI elements reset."); }

            // --- AGGREGATE STATS & DASHBOARD RENDERING ---
            function calculateAggregateStats() { const playerCount = allPlayersData.length; let totalScore = 0; let totalChests = 0; allPlayersData.forEach(player => { totalScore += player.TOTAL_SCORE || 0; totalChests += player.CHEST_COUNT || 0; }); aggregateStats = { playerCount, totalScore, totalChests, avgScore: playerCount > 0 ? Math.round(totalScore / playerCount) : 0, avgChests: playerCount > 0 ? Math.round(totalChests / playerCount) : 0 }; console.log("Aggregate stats calculated:", aggregateStats); }
            function updateStatsBar() { console.log("Starting updateStatsBar..."); try { if(!statTotalPlayers || !statTotalScore || !statTotalChests || !statAvgScore || !statAvgChests) return; statTotalPlayers.textContent = NUMERIC_FORMATTER.format(aggregateStats.playerCount); statTotalScore.textContent = NUMERIC_FORMATTER.format(aggregateStats.totalScore); statTotalChests.textContent = NUMERIC_FORMATTER.format(aggregateStats.totalChests); statAvgScore.textContent = NUMERIC_FORMATTER.format(aggregateStats.avgScore); statAvgChests.textContent = NUMERIC_FORMATTER.format(aggregateStats.avgChests); console.log("Finished updateStatsBar."); } catch (error) { console.error("Error in updateStatsBar:", error); setStatus(getText('status.renderError'), 'error', 5000); } }
            function renderDashboard() { console.log('renderDashboard called.'); try { updateStatsBar(); displayLastUpdatedTimestamp(); sortData(sortState.column, sortState.direction); renderRankingTable(displayData); renderTopSourcesChart(); renderScoreDistributionChart(); renderScoreVsChestsChart(); renderFrequentSourcesChart(); renderTopChestsTable(); console.log('renderDashboard finished successfully.'); } catch (dashboardRenderError) { console.error('Critical Error within renderDashboard orchestration:', dashboardRenderError); setStatus(getText('status.renderError'), 'error', 5000); resetDashboardUI(); } }

            // --- RANKING TABLE & CONTROLS ---
            function renderRankingTable(data) { console.log("Starting renderRankingTable..."); try { if(!rankingTableBody) return; rankingTableBody.innerHTML = ''; if (data.length === 0) { const messageKey = filterInput?.value ? 'table.noFilterMatch' : 'table.noData'; rankingTableBody.innerHTML = `<tr><td colspan="4" class="text-center py-12 text-slate-500">${getText(messageKey)}</td></tr>`; return; } const fragment = document.createDocumentFragment(); data.forEach((player, index) => { const rank = index + 1; const row = document.createElement('tr'); row.setAttribute('data-player-id', player.PLAYER); row.setAttribute('data-player-rank', rank); row.className = 'odd:bg-transparent even:bg-slate-800/50 hover:bg-slate-800 cursor-pointer transition-colors duration-150'; row.innerHTML = ` <td class="px-4 py-3 whitespace-nowrap text-sm text-right text-slate-400">${rank}</td> <td class="px-6 py-3 whitespace-nowrap text-sm font-medium text-card-foreground">${player.PLAYER}</td> <td class="px-6 py-3 whitespace-nowrap text-sm text-right text-card-foreground">${NUMERIC_FORMATTER.format(player.TOTAL_SCORE ?? 0)}</td> <td class="px-6 py-3 whitespace-nowrap text-sm text-right text-card-foreground">${NUMERIC_FORMATTER.format(player.CHEST_COUNT ?? 0)}</td> `; fragment.appendChild(row); }); rankingTableBody.appendChild(fragment); updateSortIcons(sortState.column, sortState.direction); console.log("Finished renderRankingTable."); } catch (error) { console.error("Error in renderRankingTable:", error); setStatus(getText('status.renderError'), 'error', 5000); if(rankingTableBody) rankingTableBody.innerHTML = `<tr><td colspan="4" class="text-center py-12 text-red-500">${getText('status.renderError')}</td></tr>`; } }
            function handleFilter(event) { if (!allPlayersData) return; const searchTerm = event.target.value.toLowerCase().trim(); displayData = allPlayersData.filter(player => player.PLAYER && player.PLAYER.toLowerCase().includes(searchTerm)); sortData(sortState.column, sortState.direction, false); renderRankingTable(displayData); }
            function handleSortClick(event) { if (!allPlayersData) return; const header = event.target.closest('th[data-column]'); if (!header) return; const column = header.dataset.column; let direction = (sortState.column === column) ? (sortState.direction === 'desc' ? 'asc' : 'desc') : ((column === 'PLAYER') ? 'asc' : 'desc'); sortData(column, direction, true); renderRankingTable(displayData); }
            function sortData(column, direction, updateState = true, dataToSort = displayData) { let sortTargetState = null; if(updateState) { if(dataToSort === displayData) sortTargetState = sortState; else if (dataToSort === scoreRulesData) sortTargetState = scoreRulesSortState; else if (Array.isArray(dataToSort) && dataToSort.every(item => allPlayersData.includes(item))) sortTargetState = detailedTableSortState; else console.warn("Attempting to sort unrecognized data array. State not updated."); if (sortTargetState) { sortTargetState.column = column; sortTargetState.direction = direction; console.log(`Sort state updated: ${JSON.stringify(sortTargetState)}`); } } dataToSort.sort((a, b) => { let valA = a[column]; let valB = b[column]; const isNumericComparison = typeof valA === 'number' || typeof valB === 'number'; valA = (valA === undefined || valA === null) ? (isNumericComparison ? -Infinity : '') : valA; valB = (valB === undefined || valB === null) ? (isNumericComparison ? -Infinity : '') : valB; let comparison = 0; if (typeof valA === 'number' && typeof valB === 'number') comparison = valA - valB; else { valA = String(valA).toLowerCase(); valB = String(valB).toLowerCase(); if (valA < valB) comparison = -1; if (valA > valB) comparison = 1; } return direction === 'desc' ? (comparison * -1) : comparison; }); return dataToSort; }
             function updateSortIcons(activeColumn, activeDirection, tableHeaderSelector = '#ranking-section thead th[data-column]') { try { const headers = document.querySelectorAll(tableHeaderSelector); if (!headers || headers.length === 0) return; headers.forEach(th => { const iconSpan = th.querySelector('.sort-icon'); if (!iconSpan) return; if (th.dataset.column === activeColumn) iconSpan.textContent = (activeDirection === 'desc' ? ' â–¼' : ' â–²'); else iconSpan.textContent = ''; }); } catch (error) { console.error(`Error updating sort icons for selector "${tableHeaderSelector}":`, error); } }

            // --- DETAILED TABLE VIEW ---
            function renderDetailedTable() { console.log("Starting renderDetailedTable..."); if (!detailedTableContainer) return; detailedTableContainer.innerHTML = `<div class="spinner"></div><div class="text-center text-slate-400">${getText('table.loadingDetailed')}</div>`; setTimeout(() => { try { if (allPlayersData.length === 0 || allColumnHeaders.length === 0) { detailedTableContainer.innerHTML = `<div class="text-center py-12 text-slate-500">${getText('table.noData')}</div>`; return; } const sortedHeaders = [ ...CORE_COLUMNS.filter(h => allColumnHeaders.includes(h)), ...allColumnHeaders.filter(h => !CORE_COLUMNS.includes(h)).sort() ]; const currentSortCol = detailedTableSortState.column || 'PLAYER'; const currentSortDir = detailedTableSortState.direction || 'asc'; const sortedData = sortData(currentSortCol, currentSortDir, false, [...allPlayersData]); const table = document.createElement('table'); table.className = 'min-w-full w-full divide-y divide-slate-700 text-xs'; const thead = document.createElement('thead'); thead.className = 'bg-slate-800/75 backdrop-blur-sm sticky top-0 z-10'; const headerRow = document.createElement('tr'); sortedHeaders.forEach(header => { const th = document.createElement('th'); th.scope = 'col'; th.dataset.column = header; const isNumeric = typeof sortedData[0]?.[header] === 'number' && header !== 'PLAYER'; th.className = `px-3 py-2 text-left font-medium text-primary uppercase tracking-wider cursor-pointer hover:bg-slate-700 transition-colors duration-150 ${isNumeric ? 'text-right' : 'text-left'}`; th.innerHTML = `${header.replace(/_/g, ' ')} <span class="sort-icon inline-block w-3"></span>`; headerRow.appendChild(th); }); thead.appendChild(headerRow); table.appendChild(thead); const tbody = document.createElement('tbody'); tbody.className = 'divide-y divide-slate-700'; const fragment = document.createDocumentFragment(); sortedData.forEach(player => { const row = document.createElement('tr'); row.className = 'odd:bg-transparent even:bg-slate-800/50'; sortedHeaders.forEach(header => { const cell = document.createElement('td'); const value = player[header] ?? ''; const isNumeric = typeof value === 'number' && header !== 'PLAYER'; cell.className = `px-3 py-1.5 whitespace-nowrap ${isNumeric ? 'text-right' : 'text-left'}`; cell.textContent = isNumeric ? NUMERIC_FORMATTER.format(value) : value; row.appendChild(cell); }); fragment.appendChild(row); }); tbody.appendChild(fragment); table.appendChild(tbody); detailedTableContainer.innerHTML = ''; detailedTableContainer.appendChild(table); updateSortIcons(currentSortCol, currentSortDir, '#detailed-table-container thead th[data-column]'); console.log("Finished renderDetailedTable."); } catch (error) { console.error("Error in renderDetailedTable:", error); setStatus(getText('status.renderError'), 'error', 5000); detailedTableContainer.innerHTML = `<div class="text-center py-12 text-red-500">${getText('status.renderError')}</div>`;} }, 50); }
             function handleDetailedTableSortClick(event) { const header = event.target.closest('th[data-column]'); if (!header) return; const column = header.dataset.column; let direction = 'asc'; if (detailedTableSortState.column === column) direction = detailedTableSortState.direction === 'asc' ? 'desc' : 'asc'; else direction = (typeof allPlayersData[0]?.[column] === 'number' && column !== 'PLAYER') ? 'desc' : 'asc'; detailedTableSortState.column = column; detailedTableSortState.direction = direction; renderDetailedTable(); }

            // --- SCORE SYSTEM TABLE VIEW ---
            function renderScoreRulesTable() { console.log("Starting renderScoreRulesTable..."); if (!scoreRulesTableContainer) return; scoreRulesTableContainer.innerHTML = ''; if (scoreRulesData.length === 0) { scoreRulesTableContainer.innerHTML = `<div class="text-center py-12 text-slate-500">${getText('scoreSystem.loading')}</div>`; return; } try { const currentSortCol = scoreRulesSortState.column || 'Typ'; const currentSortDir = scoreRulesSortState.direction || 'asc'; const sortedData = sortData(currentSortCol, currentSortDir, false, [...scoreRulesData]); const table = document.createElement('table'); table.className = 'min-w-full w-full divide-y divide-slate-700 text-sm'; const thead = document.createElement('thead'); thead.className = 'bg-slate-800/75 backdrop-blur-sm sticky top-0 z-10'; const headerRow = document.createElement('tr'); ['Typ', 'Level', 'Punkte'].forEach(headerKey => { const th = document.createElement('th'); th.scope = 'col'; th.dataset.column = headerKey; const isNumeric = headerKey !== 'Typ'; const headerText = getText(`scoreSystem.header${headerKey}`); th.className = `px-4 py-3 text-left font-medium text-primary uppercase tracking-wider cursor-pointer hover:bg-slate-700 transition-colors duration-150 ${isNumeric ? 'text-right' : 'text-left'}`; th.innerHTML = `${headerText} <span class="sort-icon inline-block w-3"></span>`; headerRow.appendChild(th); }); thead.appendChild(headerRow); table.appendChild(thead); const tbody = document.createElement('tbody'); tbody.className = 'divide-y divide-slate-700'; const fragment = document.createDocumentFragment(); sortedData.forEach(rule => { const row = document.createElement('tr'); row.className = 'odd:bg-transparent even:bg-slate-800/50'; row.innerHTML = ` <td class="px-4 py-2 whitespace-nowrap">${rule.Typ}</td> <td class="px-4 py-2 whitespace-nowrap text-right">${NUMERIC_FORMATTER.format(rule.Level)}</td> <td class="px-4 py-2 whitespace-nowrap text-right">${NUMERIC_FORMATTER.format(rule.Punkte)}</td> `; fragment.appendChild(row); }); tbody.appendChild(fragment); table.appendChild(tbody); scoreRulesTableContainer.appendChild(table); updateSortIcons(currentSortCol, currentSortDir, '#score-rules-table-container thead th[data-column]'); console.log("Finished renderScoreRulesTable."); } catch (error) { console.error("Error rendering score rules table:", error); setStatus(getText('status.renderError'), 'error', 5000); scoreRulesTableContainer.innerHTML = `<div class="text-center py-12 text-red-500">${getText('status.renderError')}</div>`;} }
             function handleScoreRulesTableSortClick(event) { const header = event.target.closest('th[data-column]'); if (!header) return; const column = header.dataset.column; let direction = 'asc'; if (scoreRulesSortState.column === column) direction = scoreRulesSortState.direction === 'asc' ? 'desc' : 'asc'; else direction = (column !== 'Typ') ? 'desc' : 'asc'; scoreRulesSortState.column = column; scoreRulesSortState.direction = direction; renderScoreRulesTable(); }

            // --- PLAYER DETAIL VIEW ---
            function handleTableRowClick(event) { const row = event.target.closest('tr[data-player-id]'); if (!row || !row.dataset.playerId || row.parentNode?.tagName !== 'TBODY') return; const playerId = row.dataset.playerId; const playerRank = row.dataset.playerRank || 'N/A'; const player = allPlayersData.find(p => p.PLAYER === playerId); if (player) { console.log(`Displaying details for player: ${playerId}, Rank: ${playerRank}`); renderPlayerDetail(player, playerRank); renderPlayerChart(player); switchView('detail', { playerName: player.PLAYER }); } else { console.error(`Could not find data for player ID: ${playerId}`); setStatus(`Could not find details for player: ${playerId}`, 'error', 3000); } }
            function renderPlayerDetail(player, rank) { console.log("Starting renderPlayerDetail for:", player?.PLAYER); try { if (!playerNameDetail || !playerScoreDetail || !playerChestsDetail || !playerRankDetail || !playerBreakdownList) return; playerNameDetail.textContent = player.PLAYER; playerScoreDetail.textContent = NUMERIC_FORMATTER.format(player.TOTAL_SCORE ?? 0); playerChestsDetail.textContent = NUMERIC_FORMATTER.format(player.CHEST_COUNT ?? 0); playerRankDetail.textContent = rank; playerBreakdownList.innerHTML = ''; const fragment = document.createDocumentFragment(); const categoryKeys = Object.keys(player).filter(key => !CORE_COLUMNS.includes(key) && typeof player[key] === 'number' && player[key] > 0).sort((keyA, keyB) => (player[keyB] ?? 0) - (player[keyA] ?? 0)); if (categoryKeys.length === 0) { playerBreakdownList.innerHTML = `<p class="text-slate-500">${getText('playerDetail.noBreakdown')}</p>`; return; } categoryKeys.forEach(category => { const score = player[category]; const p = document.createElement('p'); p.className = "flex justify-between items-baseline"; const displayName = category.replace(/_/g, ' '); p.innerHTML = `<span class="font-medium text-slate-400 inline-block max-w-[70%] truncate pr-2" title="${displayName}">${displayName}:</span> <span class="text-right text-card-foreground">${NUMERIC_FORMATTER.format(score)}</span>`; fragment.appendChild(p); }); playerBreakdownList.appendChild(fragment); console.log("Finished renderPlayerDetail."); } catch (error) { console.error("Error in renderPlayerDetail:", error); setStatus(getText('status.renderError'), 'error', 5000); if(playerBreakdownList) playerBreakdownList.innerHTML = `<p class="text-red-500">${getText('status.renderError')}</p>`; } }

            // --- CATEGORY ANALYSIS VIEW ---
            function populateCategoryDropdown(headers) { if(!categorySelect) return; categorySelect.length = 1; headers.filter(header => !CORE_COLUMNS.includes(header)).sort().forEach(header => { const option = document.createElement('option'); option.value = header; option.textContent = header.replace(/_/g, ' '); categorySelect.appendChild(option); }); console.log("Category dropdown populated."); }
             function handleCategorySelect(event) { const selectedCategory = event.target.value; if (selectedCategory) { console.log(`Category selected: ${selectedCategory}`); categoryPrompt.classList.add('hidden'); categoryAnalysisContent.classList.remove('hidden'); renderCategoryAnalysis(selectedCategory); renderCategoryChart(allPlayersData, selectedCategory); } else { console.log("No category selected."); categoryAnalysisContent.classList.add('hidden'); categoryPrompt.classList.remove('hidden'); if (chartInstances.category) { try { chartInstances.category.destroy(); } catch(e){} chartInstances.category = null; if(categoryChartContainer) categoryChartContainer.innerHTML = ''; } if(categoryRankingBody) categoryRankingBody.innerHTML = `<tr><td colspan="2" class="text-center py-4 text-slate-500">${getText('analytics.selectCategoryPrompt')}</td></tr>`; if(categoryNameTable) categoryNameTable.textContent = '[Category Name]'; if(categoryNameChart) categoryNameChart.textContent = '[Category Name]'; } }
            function renderCategoryAnalysis(category) { console.log("Starting renderCategoryAnalysis for:", category); try { const readableCategory = category.replace(/_/g, ' '); if(categoryNameTable) categoryNameTable.textContent = readableCategory; if(categoryNameChart) categoryNameChart.textContent = readableCategory; if(!categoryRankingBody) return; categoryRankingBody.innerHTML = ''; const categoryData = allPlayersData.filter(player => player.hasOwnProperty(category) && typeof player[category] === 'number' && player[category] > 0).sort((a, b) => (b[category] ?? 0) - (a[category] ?? 0)); if (categoryData.length === 0) { categoryRankingBody.innerHTML = `<tr><td colspan="2" class="text-center py-4 text-slate-500">${getText('table.noData')}</td></tr>`; return; } const fragment = document.createDocumentFragment(); categoryData.forEach(player => { const row = document.createElement('tr'); row.className = 'odd:bg-transparent even:bg-slate-800/50'; row.innerHTML = ` <td class="px-4 py-2 whitespace-nowrap font-medium">${player.PLAYER}</td> <td class="px-4 py-2 whitespace-nowrap text-right">${NUMERIC_FORMATTER.format(player[category] ?? 0)}</td> `; fragment.appendChild(row); }); categoryRankingBody.appendChild(fragment); console.log("Finished renderCategoryAnalysis."); } catch (error) { console.error("Error in renderCategoryAnalysis:", error); setStatus(getText('status.renderError'), 'error', 5000); if(categoryRankingBody) categoryRankingBody.innerHTML = `<tr><td colspan="2" class="text-center py-4 text-red-500">${getText('status.renderError')}</td></tr>`; } }

             // --- CHARTS VIEW ---
             function renderChartsView() { console.log('Rendering Charts View...'); const container = document.getElementById('charts-section'); if(!container) { console.error("Charts section container not found!"); return; } if (allPlayersData.length === 0) { container.innerHTML = `<h2 class="text-xl font-semibold font-serif text-amber-300 border-l-4 border-primary pl-4" data-i18n-key="charts.title">Charts Overview</h2><p class="text-center text-slate-400 py-10">${getText('table.noData')}</p>`; updateUIText(); return; } container.innerHTML = ` <h2 class="text-xl font-semibold font-serif text-amber-300 border-l-4 border-primary pl-4" data-i18n-key="charts.title">Charts Overview</h2> <div class="grid grid-cols-1 md:grid-cols-2 gap-6 lg:gap-8"> <div class="bg-card border border-border rounded-lg shadow-lg p-6 relative"> <button class="absolute top-2 right-2 p-1 text-slate-400 hover:text-primary focus-visible:ring-0" data-i18n-title-key="button.viewLarger" title="View Larger" data-chart-type="topSources"> <i class="fas fa-expand fa-fw"></i> </button> <h3 class="text-base font-semibold text-amber-300 mb-3" data-i18n-key="dashboard.chartTopSourcesTitle">Top Sources by Score</h3> <div id="charts-top-sources-container" class="min-h-[350px]"></div> </div> <div class="bg-card border border-border rounded-lg shadow-lg p-6 relative"> <button class="absolute top-2 right-2 p-1 text-slate-400 hover:text-primary focus-visible:ring-0" data-i18n-title-key="button.viewLarger" title="View Larger" data-chart-type="scoreDistribution"> <i class="fas fa-expand fa-fw"></i> </button> <h3 class="text-base font-semibold text-amber-300 mb-3" data-i18n-key="dashboard.chartScoreDistTitle">Score Distribution</h3> <div id="charts-distribution-container" class="min-h-[350px]"></div> </div> <div class="bg-card border border-border rounded-lg shadow-lg p-6 relative"> <button class="absolute top-2 right-2 p-1 text-slate-400 hover:text-primary focus-visible:ring-0" data-i18n-title-key="button.viewLarger" title="View Larger" data-chart-type="scoreVsChests"> <i class="fas fa-expand fa-fw"></i> </button> <h3 class="text-base font-semibold text-amber-300 mb-3" data-i18n-key="dashboard.chartScoreVsChestsTitle">Score vs. Chests</h3> <div id="charts-score-vs-chests-container" class="min-h-[350px]"></div> </div> <div class="bg-card border border-border rounded-lg shadow-lg p-6 relative"> <button class="absolute top-2 right-2 p-1 text-slate-400 hover:text-primary focus-visible:ring-0" data-i18n-title-key="button.viewLarger" title="View Larger" data-chart-type="frequentSources"> <i class="fas fa-expand fa-fw"></i> </button> <h3 class="text-base font-semibold text-amber-300 mb-3" data-i18n-key="dashboard.chartFreqSourcesTitle">Most Frequent Sources</h3> <div id="charts-frequent-sources-container" class="min-h-[350px]"></div> </div> </div>`; updateUIText(); chartsTopSourcesContainer = document.getElementById('charts-top-sources-container'); chartsDistributionContainer = document.getElementById('charts-distribution-container'); chartsScoreVsChestsContainer = document.getElementById('charts-score-vs-chests-container'); chartsFrequentSourcesContainer = document.getElementById('charts-frequent-sources-container'); renderTopSourcesChart('charts-top-sources-container'); renderScoreDistributionChart('charts-distribution-container'); renderScoreVsChestsChart('charts-score-vs-chests-container'); renderFrequentSourcesChart('charts-frequent-sources-container'); }

            // --- DASHBOARD WIDGETS RENDERING ---
            function renderTopChestsTable() { console.log("Starting renderTopChestsTable..."); try { if(!topChestsTableBody) return; topChestsTableBody.innerHTML = ''; const topPlayers = [...allPlayersData].sort((a, b) => (b.CHEST_COUNT || 0) - (a.CHEST_COUNT || 0)).slice(0, 5); if (topPlayers.length === 0) { topChestsTableBody.innerHTML = `<tr><td colspan="2" class="text-center py-4 text-slate-500 text-xs">${getText('table.noData')}</td></tr>`; return; } const fragment = document.createDocumentFragment(); topPlayers.forEach(player => { const row = document.createElement('tr'); row.className = 'odd:bg-transparent even:bg-slate-800/50 hover:bg-slate-800 cursor-pointer transition-colors duration-150'; row.setAttribute('data-player-id', player.PLAYER); row.innerHTML = ` <td class="px-3 py-2 whitespace-nowrap font-medium truncate" title="${player.PLAYER}">${player.PLAYER}</td> <td class="px-3 py-2 whitespace-nowrap text-right">${NUMERIC_FORMATTER.format(player.CHEST_COUNT || 0)}</td> `; fragment.appendChild(row); }); topChestsTableBody.appendChild(fragment); console.log("Finished renderTopChestsTable."); } catch (error) { console.error("Error in renderTopChestsTable:", error); setStatus(getText('status.renderError'), 'error', 5000); if(topChestsTableBody) topChestsTableBody.innerHTML = `<tr><td colspan="2" class="text-center py-4 text-red-500 text-xs">${getText('status.renderError')}</td></tr>`; } }

            // --- CHARTING ---
            function getCssVariableValue(variableName) { try { return window.getComputedStyle(document.documentElement).getPropertyValue(variableName).trim(); } catch (e) { console.error(`Error getting CSS variable ${variableName}:`, e); if (variableName === '--primary') return 'hsl(40.7 92.9% 56.1%)'; if (variableName === '--foreground') return 'hsl(210 40% 96.1%)'; if (variableName === '--secondary') return 'hsl(346.8 77.2% 49.8%)'; return '#ffffff'; } }
            function getChartBaseOptions() { try { const foregroundColor = `hsl(${getCssVariableValue('--foreground')})`; const primaryColor = `hsl(${getCssVariableValue('--primary')})`; const secondaryColor = `hsl(${getCssVariableValue('--secondary')})`; const options = { chart: { foreColor: foregroundColor, toolbar: { show: true, tools: { download: true } }, background: 'transparent', padding: { top: 5, right: 10, bottom: 5, left: 10 } }, theme: { mode: 'dark', palette: 'palette1' }, grid: { borderColor: `hsla(${getCssVariableValue('--border')}, 0.3)` }, tooltip: { theme: 'dark', style: { fontSize: '12px' }, x: { formatter: (val) => val }, y: { formatter: (val) => val !== undefined && val !== null ? NUMERIC_FORMATTER.format(val) : '' } }, colors: [primaryColor, secondaryColor, '#00E396', '#FEB019', '#775DD0', '#FF4560', '#008FFB'], xaxis: { labels: { style: { colors: foregroundColor }, trim: true, rotate: -45, rotateAlways: false, hideOverlappingLabels: true, maxHeight: 100 }, tooltip: { enabled: false } }, yaxis: { labels: { style: { colors: foregroundColor }, formatter: function (val) { if (val === null || val === undefined) return ''; if (Math.abs(val) >= 1000000) return (val / 1000000).toFixed(1) + 'M'; if (Math.abs(val) >= 1000) return (val / 1000).toFixed(0) + 'K'; return NUMERIC_FORMATTER.format(val); } } }, dataLabels: { enabled: false } }; return options; } catch (e) { console.error("Error in getChartBaseOptions:", e); return { chart: { toolbar: { show: true, tools: { download: true } } }, theme: { mode: 'dark'} }; } }
             function renderTopSourcesChart(containerId = 'top-sources-chart-container') { const instanceKey = (containerId === 'modal-chart-container') ? 'modalChart' : (containerId.startsWith('charts-') ? 'topSourcesChartsPage' : 'topSources'); console.log(`Starting renderTopSourcesChart in #${containerId} (key: ${instanceKey})`); try { const container = document.getElementById(containerId); if (!container) return; if (chartInstances[instanceKey]) { try { chartInstances[instanceKey].destroy(); } catch(e){} chartInstances[instanceKey] = null; } container.innerHTML = '<div class="spinner mx-auto my-8"></div>'; const categoryScores = {}; allPlayersData.forEach(player => { Object.keys(player).forEach(key => { if (!CORE_COLUMNS.includes(key) && typeof player[key] === 'number' && player[key] > 0) categoryScores[key] = (categoryScores[key] || 0) + player[key]; }); }); const sortedCategories = Object.entries(categoryScores).sort(([, scoreA], [, scoreB]) => scoreB - scoreA); const topN = 7; let topCategoriesData = sortedCategories.slice(0, topN); let otherScore = sortedCategories.slice(topN).reduce((sum, [, score]) => sum + score, 0); let chartLabels = topCategoriesData.map(([key]) => key.replace(/_/g, ' ')); let chartSeries = topCategoriesData.map(([, score]) => score); if (otherScore > 0) { chartLabels.push(getText('charts.othersCategory')); chartSeries.push(otherScore); } console.log('TopSourcesChart Data:', { labels: chartLabels, series: chartSeries }); if (chartLabels.length === 0) { container.innerHTML = `<p class="text-slate-500 text-sm text-center py-8">${getText('table.noData')}</p>`; return; } const baseOptions = getChartBaseOptions(); const options = { ...baseOptions, chart: { ...baseOptions.chart, type: 'donut', height: (containerId.startsWith('charts-') || containerId === 'modal-chart-container' ? 350 : 280), padding: undefined }, series: chartSeries, labels: chartLabels, legend: { position: 'bottom', fontSize: '11px', labels: { colors: baseOptions.chart.foreColor }, markers: { radius: 2 }, itemMargin: { horizontal: 5, vertical: 2 } }, plotOptions: { pie: { donut: { size: '65%', labels: { show: true, total: { show: true, label: getText('table.headerTotalScore'), formatter: (w) => { const total = w.globals.seriesTotals.reduce((a, b) => a + b, 0); return NUMERIC_FORMATTER.format(total); } } } } } }, responsive: [{ breakpoint: 480, options: { legend: { position: 'bottom' } } }], tooltip: { theme: 'dark', y: { formatter: (value) => NUMERIC_FORMATTER.format(value), title: { formatter: (seriesName, opts) => (opts?.w?.globals?.labels?.[opts.seriesIndex] ?? seriesName) } } }, xaxis: undefined, yaxis: undefined }; chartInstances[instanceKey] = new ApexCharts(container, options); chartInstances[instanceKey].render().then(() => { container.querySelector('.spinner')?.remove(); }).catch(e => { throw e; }); console.log(`Finished renderTopSourcesChart in #${containerId}.`); } catch (e) { console.error(`Error rendering top sources chart in #${containerId}:`, e); const container = document.getElementById(containerId); if(container) container.innerHTML = `<p class="text-red-500 text-sm text-center py-8">${getText('status.chartError')}</p>`; if (chartInstances[instanceKey]) { try { chartInstances[instanceKey].destroy(); } catch(destroyError) {} chartInstances[instanceKey] = null; } } }
            function renderScoreDistributionChart(containerId = 'score-distribution-chart-container') { const instanceKey = (containerId === 'modal-chart-container') ? 'modalChart' : (containerId.startsWith('charts-') ? 'scoreDistributionChartsPage' : 'scoreDistribution'); console.log(`Starting renderScoreDistributionChart in #${containerId} (key: ${instanceKey})`); try { const container = document.getElementById(containerId); if (!container) return; if (chartInstances[instanceKey]) { try { chartInstances[instanceKey].destroy(); } catch(e){} chartInstances[instanceKey] = null; } container.innerHTML = '<div class="spinner mx-auto my-8"></div>'; if (allPlayersData.length === 0) { container.innerHTML = `<p class="text-slate-500 text-sm text-center py-8">${getText('table.noData')}</p>`; return; } const scores = allPlayersData.map(p => p.TOTAL_SCORE || 0); const maxScore = Math.max(...scores, 0); let bracketSize; if (maxScore > 1000000) bracketSize = 200000; else if (maxScore > 500000) bracketSize = 100000; else if (maxScore > 100000) bracketSize = 50000; else if (maxScore > 20000) bracketSize = 10000; else if (maxScore > 5000) bracketSize = 2500; else if (maxScore > 1000) bracketSize = 1000; else if (maxScore > 100) bracketSize = 100; else bracketSize = 50; const numBrackets = Math.max(1, Math.ceil(maxScore / bracketSize)); const brackets = Array.from({ length: numBrackets }, (_, i) => ({ min: i * bracketSize, max: (i + 1) * bracketSize, count: 0 })); scores.forEach(score => { for (let i = 0; i < brackets.length; i++) { if ((i === brackets.length - 1 && score >= brackets[i].min) || (score >= brackets[i].min && score < brackets[i].max)) { brackets[i].count++; break; } } }); const chartLabels = brackets.map(b => `${NUMERIC_FORMATTER.format(b.min / 1000)}k-${NUMERIC_FORMATTER.format(b.max / 1000)}k`); const chartSeries = brackets.map(b => b.count); console.log('ScoreDistributionChart Data:', { labels: chartLabels, series: chartSeries }); const baseOptions = getChartBaseOptions(); const options = { ...baseOptions, chart: { ...baseOptions.chart, type: 'bar', height: (containerId.startsWith('charts-') || containerId === 'modal-chart-container' ? 350 : 280) }, series: [{ name: getText('dashboard.statPlayers'), data: chartSeries }], xaxis: { ...baseOptions.xaxis, categories: chartLabels, labels: { ...baseOptions.xaxis.labels, style: { fontSize: '10px'}, rotate: -60 } }, yaxis: { ...baseOptions.yaxis, title: { text: getText('dashboard.statPlayers'), style: { fontSize: '10px', color: baseOptions.chart.foreColor } }, labels: { ...baseOptions.yaxis.labels, formatter: (val) => val !== undefined && val !== null ? Math.round(val).toLocaleString() : '' } }, plotOptions: { bar: { horizontal: false, borderRadius: 2, columnWidth: '80%' } }, tooltip: { theme: 'dark', x: { formatter: (val, { dataPointIndex, w }) => { if (w?.globals?.categories?.[dataPointIndex] !== undefined) return `${getText('table.headerScore')}: ${w.globals.categories[dataPointIndex]}`; return ''; } }, y: { formatter: (val) => val !== undefined && val !== null ? `${NUMERIC_FORMATTER.format(val)} ${getText('dashboard.statPlayers').toLowerCase()}` : '' } } }; chartInstances[instanceKey] = new ApexCharts(container, options); chartInstances[instanceKey].render().then(() => { container.querySelector('.spinner')?.remove(); }).catch(e => { throw e; }); console.log(`Finished renderScoreDistributionChart in #${containerId}.`); } catch (e) { console.error(`Error rendering score distribution chart in #${containerId}:`, e); const container = document.getElementById(containerId); if(container) container.innerHTML = `<p class="text-red-500 text-sm text-center py-8">${getText('status.chartError')}</p>`; if (chartInstances[instanceKey]) { try { chartInstances[instanceKey].destroy(); } catch(destroyError) {} chartInstances[instanceKey] = null; } } }
            function renderScoreVsChestsChart(containerId = 'score-vs-chests-chart-container') { const instanceKey = (containerId === 'modal-chart-container') ? 'modalChart' : (containerId.startsWith('charts-') ? 'scoreVsChestsChartsPage' : 'scoreVsChests'); console.log(`Starting renderScoreVsChestsChart in #${containerId} (key: ${instanceKey})`); try { const container = document.getElementById(containerId); if (!container) return; if (chartInstances[instanceKey]) { try { chartInstances[instanceKey].destroy(); } catch(e){} chartInstances[instanceKey] = null; } container.innerHTML = '<div class="spinner mx-auto my-8"></div>'; if (allPlayersData.length === 0) { container.innerHTML = `<p class="text-slate-500 text-sm text-center py-8">${getText('table.noData')}</p>`; return; } const seriesData = allPlayersData.map(player => ({ x: player.CHEST_COUNT || 0, y: player.TOTAL_SCORE || 0, name: player.PLAYER })); console.log(`ScoreVsChestsChart Data Points: ${seriesData.length}`); const baseOptions = getChartBaseOptions(); const options = { ...baseOptions, chart: { ...baseOptions.chart, type: 'scatter', height: (containerId.startsWith('charts-') || containerId === 'modal-chart-container' ? 350 : 280), zoom: { enabled: true, type: 'xy'} }, series: [{ name: getText('table.headerPlayer'), data: seriesData }], xaxis: { ...baseOptions.xaxis, tickAmount: 8, title: { text: getText('table.headerChestCount'), style: { fontSize: '10px', color: baseOptions.chart.foreColor } }, labels: { ...baseOptions.xaxis.labels, formatter: (val) => val !== undefined ? NUMERIC_FORMATTER.format(Math.round(val)) : '', rotate: 0 } }, yaxis: { ...baseOptions.yaxis, tickAmount: 6, title: { text: getText('table.headerTotalScore'), style: { fontSize: '10px', color: baseOptions.chart.foreColor } } }, tooltip: { theme: 'dark', custom: function({ series, seriesIndex, dataPointIndex, w }) { const dataPoint = w.globals.initialSeries[seriesIndex]?.data[dataPointIndex]; if (!dataPoint) return ''; return `<div class="apexcharts-tooltip-title" style="font-size: 12px; background: rgba(0,0,0,0.7); border: 1px solid ${baseOptions.grid.borderColor};">${dataPoint.name || ''}</div><div class="apexcharts-tooltip-series-group" style="padding:5px 10px; background: rgba(0,0,0,0.6); border: 1px solid ${baseOptions.grid.borderColor}; border-top: 0;"><span class="apexcharts-tooltip-marker" style="background-color: ${w.globals.colors[seriesIndex]}"></span><span class="apexcharts-tooltip-text">${getText('table.headerChests')}: ${NUMERIC_FORMATTER.format(dataPoint.x)}<br/>${getText('table.headerScore')}: ${NUMERIC_FORMATTER.format(dataPoint.y)}</span></div>`; } }, markers: { size: 4, hover: { size: 7 } } }; chartInstances[instanceKey] = new ApexCharts(container, options); chartInstances[instanceKey].render().then(() => { container.querySelector('.spinner')?.remove(); }).catch(e => { throw e; }); console.log(`Finished renderScoreVsChestsChart in #${containerId}.`); } catch (e) { console.error(`Error rendering score vs chests chart in #${containerId}:`, e); const container = document.getElementById(containerId); if(container) container.innerHTML = `<p class="text-red-500 text-sm text-center py-8">${getText('status.chartError')}</p>`; if (chartInstances[instanceKey]) { try { chartInstances[instanceKey].destroy(); } catch(destroyError) {} chartInstances[instanceKey] = null; } } }
            function renderFrequentSourcesChart(containerId = 'frequent-sources-chart-container') {
                const instanceKey = (containerId === 'modal-chart-container') ? 'modalChart' : (containerId.startsWith('charts-') ? 'frequentSourcesChartsPage' : 'frequentSources');
                console.log(`Starting renderFrequentSourcesChart in #${containerId} (key: ${instanceKey})`);
                try {
                    const container = document.getElementById(containerId);
                    if (!container) return;
                    if (chartInstances[instanceKey]) { try { chartInstances[instanceKey].destroy(); } catch (e) {} chartInstances[instanceKey] = null; }
                    container.innerHTML = '<div class="spinner mx-auto my-8"></div>';
                    if (allPlayersData.length === 0) { container.innerHTML = `<p class="text-slate-500 text-sm text-center py-8">${getText('table.noData')}</p>`; return; }
                    const categoryCounts = {};
                    allPlayersData.forEach(player => { Object.keys(player).forEach(key => { if (!CORE_COLUMNS.includes(key) && typeof player[key] === 'number' && player[key] > 0) categoryCounts[key] = (categoryCounts[key] || 0) + 1; }); });
                    const sortedCategories = Object.entries(categoryCounts).sort(([, countA], [, countB]) => countB - countA);
                    const topN = 10;
                    const topCategoriesData = sortedCategories.slice(0, topN);
                    const chartLabels = topCategoriesData.map(([key]) => key.replace(/_/g, ' '));
                    const chartSeries = topCategoriesData.map(([, count]) => count);
                    console.log('FrequentSourcesChart Data:', { labels: chartLabels, series: chartSeries });
                    if (topCategoriesData.length === 0) { container.innerHTML = `<p class="text-slate-500 text-sm text-center py-8">${getText('table.noData')}</p>`; return; }
                    const baseOptions = getChartBaseOptions();
                    const options = {
                        ...baseOptions,
                        chart: { ...baseOptions.chart, type: 'bar', height: (containerId.startsWith('charts-') || containerId === 'modal-chart-container' ? 350 : 280) },
                        series: [{ name: getText('dashboard.statPlayers'), data: chartSeries }],
                        xaxis: { ...baseOptions.xaxis, categories: chartLabels, labels: { ...baseOptions.xaxis.labels, show: true, formatter: (val) => val !== undefined ? NUMERIC_FORMATTER.format(Math.round(val)) : '', rotate: 0} }, // Show X-axis labels (player counts)
                        yaxis: {
                            ...baseOptions.yaxis,
                            labels: {
                                ...baseOptions.yaxis.labels,
                                formatter: undefined, // Use category names directly - FIX for NaN
                                style: { fontSize: '11px' }
                            }
                        },
                        plotOptions: { bar: { horizontal: true, borderRadius: 2, barHeight: '60%' } },
                        tooltip: { theme: 'dark',
                            x: { formatter: (val) => `${NUMERIC_FORMATTER.format(val)} ${getText('dashboard.statPlayers').toLowerCase()}` },
                            y: { formatter: undefined, title: { formatter: (seriesName, { seriesIndex, dataPointIndex, w }) => `${getText('charts.sourceLabel')}: ${w.globals.labels[dataPointIndex]}` } } // Show label in tooltip y title
                        },
                        grid: { ...baseOptions.grid, yaxis: { lines: { show: false } } }
                    };
                    chartInstances[instanceKey] = new ApexCharts(container, options);
                    chartInstances[instanceKey].render().then(() => { container.querySelector('.spinner')?.remove(); }).catch(e => { throw e; });
                    console.log(`Finished renderFrequentSourcesChart in #${containerId}.`);
                } catch (e) {
                    console.error(`Error rendering frequent sources chart in #${containerId}:`, e);
                    const container = document.getElementById(containerId); if (container) container.innerHTML = `<p class="text-red-500 text-sm text-center py-8">${getText('status.chartError')}</p>`;
                    if (chartInstances[instanceKey]) { try { chartInstances[instanceKey].destroy(); } catch (destroyError) {} chartInstances[instanceKey] = null; }
                }
            }
             function renderPlayerChart(player, containerId = 'player-chart-container') { const instanceKey = (containerId === 'modal-chart-container') ? 'modalChart' : 'player'; console.log(`Starting renderPlayerChart in #${containerId} (key: ${instanceKey}) for ${player?.PLAYER}...`); try { const container = document.getElementById(containerId); if (!container || !player) return; if (chartInstances[instanceKey]) { try { chartInstances[instanceKey].destroy(); } catch(e){} chartInstances[instanceKey] = null; } container.innerHTML = '<div class="spinner mx-auto my-8"></div>'; const categoryKeys = Object.keys(player).filter(key => !CORE_COLUMNS.includes(key) && typeof player[key] === 'number' && player[key] > 0).sort((keyA, keyB) => (player[keyB] ?? 0) - (player[keyA] ?? 0)); const topN = 8; const radarCategories = categoryKeys.slice(0, topN); if (radarCategories.length < 3) { container.innerHTML = `<p class="text-slate-500 text-center py-8">${getText('charts.notEnoughDataRadar')}</p>`; return; } const categoryNames = radarCategories.map(key => key.replace(/_/g, ' ')); const categoryScores = radarCategories.map(key => player[key] ?? 0); console.log('PlayerChart Data:', { labels: categoryNames, series: categoryScores }); const baseOptions = getChartBaseOptions(); const primaryColor = `hsl(${getCssVariableValue('--primary')})`; const options = { ...baseOptions, chart: { ...baseOptions.chart, type: 'radar', height: (containerId === 'modal-chart-container' ? 450 : 350) }, series: [{ name: getText('table.headerScore'), data: categoryScores }], xaxis: { categories: categoryNames, labels: { ...baseOptions.xaxis.labels, style: { ...baseOptions.xaxis.labels.style, fontSize: '11px' }, rotate: 0, hideOverlappingLabels: false, formatter: function(value) { const maxLength = 15; if (value && value.length > maxLength) { const words = value.split(' '); let lines = []; let currentLine = ''; words.forEach(word => { if ((currentLine + word).length <= maxLength) currentLine += (currentLine ? ' ' : '') + word; else { lines.push(currentLine); currentLine = word; } }); lines.push(currentLine); return lines; } return value; } } }, yaxis: { labels: { ...baseOptions.yaxis.labels, formatter: (val) => val !== undefined && val !== null ? baseOptions.yaxis.labels.formatter(val) : '' }, tickAmount: 4 }, stroke: { show: true, width: 2, colors: [primaryColor], dashArray: 0 }, fill: { colors: [primaryColor], opacity: 0.3 }, markers: { size: 4, colors: [`hsl(${getCssVariableValue('--background')})`], strokeColors: [primaryColor], strokeWidth: 2, hover: { size: 6 } }, tooltip: { theme: 'dark', y: { formatter: function(val) { return val !== undefined && val !== null ? NUMERIC_FORMATTER.format(val) : ''; } } } }; chartInstances[instanceKey] = new ApexCharts(container, options); chartInstances[instanceKey].render().then(() => { container.querySelector('.spinner')?.remove(); }).catch(e => { throw e; }); console.log(`Finished renderPlayerChart in #${containerId}.`); } catch (e) { console.error(`Error rendering player chart for ${player?.PLAYER}:`, e); const container = document.getElementById(containerId); if(container) container.innerHTML = `<p class="text-red-500 text-sm text-center py-8">${getText('status.chartError')}</p>`; if (chartInstances[instanceKey]) { try { chartInstances[instanceKey].destroy(); } catch(destroyError) {} chartInstances[instanceKey] = null; } } }
            function renderCategoryChart(data, category, containerId = 'category-chart-container') { const instanceKey = (containerId === 'modal-chart-container') ? 'modalChart' : 'category'; console.log(`Starting renderCategoryChart in #${containerId} (key: ${instanceKey}) for ${category}...`); try { const container = document.getElementById(containerId); if (!container || !category) return; if (chartInstances[instanceKey]) { try { chartInstances[instanceKey].destroy(); } catch(e){} chartInstances[instanceKey] = null; } container.innerHTML = '<div class="spinner mx-auto my-8"></div>'; const topN = 15; const topPlayers = data.filter(player => player.hasOwnProperty(category) && typeof player[category] === 'number' && player[category] > 0).sort((a, b) => (b[category] ?? 0) - (a[category] ?? 0)).slice(0, topN); if (topPlayers.length === 0) { container.innerHTML = `<p class="text-slate-500 text-center py-8">${getText('table.noData')}</p>`; return; } const playerNames = topPlayers.map(p => p.PLAYER); const playerScores = topPlayers.map(p => p[category] ?? 0); console.log('CategoryChart Data:', { labels: playerNames, series: playerScores }); const baseOptions = getChartBaseOptions(); const options = { ...baseOptions, chart: { ...baseOptions.chart, type: 'bar', height: (containerId === 'modal-chart-container' ? 500 : 400) }, series: [{ name: category.replace(/_/g, ' '), data: playerScores }], xaxis: { ...baseOptions.xaxis, categories: playerNames, labels: { ...baseOptions.xaxis.labels, rotate: -45, style: { fontSize: '10px' } } }, yaxis: { ...baseOptions.yaxis }, plotOptions: { bar: { horizontal: false, columnWidth: '60%', borderRadius: 4 } }, tooltip: { theme: 'dark', y: { formatter: (val) => val !== undefined && val !== null ? NUMERIC_FORMATTER.format(val) : '' } } }; chartInstances[instanceKey] = new ApexCharts(container, options); chartInstances[instanceKey].render().then(() => { container.querySelector('.spinner')?.remove(); }).catch(e => { throw e; }); console.log(`Finished renderCategoryChart in #${containerId}.`); } catch (e) { console.error(`Error rendering category chart for ${category}:`, e); const container = document.getElementById(containerId); if(container) container.innerHTML = `<p class="text-red-500 text-sm text-center py-8">${getText('status.chartError')}</p>`; if (chartInstances[instanceKey]) { try { chartInstances[instanceKey].destroy(); } catch(destroyError) {} chartInstances[instanceKey] = null; } } }

            // --- Chart Modal Logic ---
             function handleExpandChartClick(event) { const button = event.target.closest('button[data-chart-type]'); if (!button) return; const chartType = button.dataset.chartType; console.log(`Expanding chart: ${chartType}`); let titleKey = ''; modalChartContainer.innerHTML = '<div class="spinner mx-auto my-8"></div>'; if (chartInstances.modalChart) { try { chartInstances.modalChart.destroy(); } catch(e) { console.warn("Error destroying previous modal chart instance:", e); } chartInstances.modalChart = null; } if (allPlayersData.length === 0) { modalChartContainer.innerHTML = `<p class="text-center text-slate-400">${getText('table.noData')}</p>`; } else { switch (chartType) { case 'topSources': titleKey = 'dashboard.chartTopSourcesTitle'; renderTopSourcesChart('modal-chart-container'); break; case 'scoreDistribution': titleKey = 'dashboard.chartScoreDistTitle'; renderScoreDistributionChart('modal-chart-container'); break; case 'scoreVsChests': titleKey = 'dashboard.chartScoreVsChestsTitle'; renderScoreVsChestsChart('modal-chart-container'); break; case 'frequentSources': titleKey = 'dashboard.chartFreqSourcesTitle'; renderFrequentSourcesChart('modal-chart-container'); break; default: console.error(`Unknown chart type for expand: ${chartType}`); modalChartContainer.innerHTML = `<p class="text-center text-red-500">Unknown chart type.</p>`; } } modalChartTitle.textContent = getText(titleKey || 'Chart'); chartModal.classList.remove('hidden'); }
             function handleModalClose() { console.log("Closing chart modal"); if (chartInstances.modalChart) { try { chartInstances.modalChart.destroy(); } catch(e) { console.warn("Error destroying modal chart:", e); } chartInstances.modalChart = null; } modalChartContainer.innerHTML = ''; chartModal.classList.add('hidden'); }

            // --- DOWNLOAD FUNCTIONS ---
             function downloadFullDataCSV() { if (allPlayersData.length === 0) { setStatus(getText('table.noData'), 'error', 3000); return; } try { setStatus(getText('status.generatingCsv', {}), 'info'); const csv = Papa.unparse(allPlayersData, { columns: allColumnHeaders, header: true }); triggerDownload(csv, 'totalbattle_chest_data.csv', 'text/csv;charset=utf-8;'); setStatus(getText('status.downloadInitiated', {0: 'CSV'}), 'success', 3000); } catch (error) { console.error("Error generating CSV:", error); setStatus(getText('status.downloadError', {0: 'CSV'}), 'error', 3000); } }
             function downloadPlayerDataJSON(playerData) { if (!playerData) { setStatus(getText('status.noPlayerData'), 'error', 3000); return; } try { setStatus(getText('status.generatingJson', {}), 'info'); const jsonString = JSON.stringify(playerData, null, 2); const filenameSafePlayerName = String(playerData.PLAYER || 'data').replace(/[^a-z0-9]/gi, '_').toLowerCase(); const filename = `player_${filenameSafePlayerName}.json`; triggerDownload(jsonString, filename, 'application/json;charset=utf-8;'); setStatus(getText('status.downloadInitiated', {0: 'Player JSON'}), 'success', 3000); } catch (error) { console.error("Error generating player JSON:", error); setStatus(getText('status.downloadError', {0: 'Player JSON'}), 'error', 3000); } }
             function triggerDownload(content, filename, contentType){ const blob = new Blob([content], { type: contentType }); const link = document.createElement("a"); const url = URL.createObjectURL(blob); link.setAttribute("href", url); link.setAttribute("download", filename); link.style.visibility = 'hidden'; document.body.appendChild(link); link.click(); document.body.removeChild(link); URL.revokeObjectURL(url); console.log(`Download triggered for: ${filename}`); }

        }); // End DOMContentLoaded listener
    </script>

</body>
</html>