<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>State Debug Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        pre {
            white-space: pre-wrap;
            word-break: break-all;
            background-color: #f0f0f0;
            padding: 10px;
            border-radius: 5px;
        }
        button {
            margin: 5px;
            padding: 8px 16px;
            background-color: #2563eb;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        button:hover {
            background-color: #1d4ed8;
        }
    </style>
</head>
<body class="p-6">
    <h1 class="text-2xl font-bold mb-4">State Debug Tool</h1>
    
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
        <div>
            <h2 class="text-xl font-semibold mb-2">Action</h2>
            <div class="flex flex-wrap">
                <button id="check-state">Check State</button>
                <button id="load-fallback-weeks">Load Fallback Weeks</button>
                <button id="load-csv">Load CSV Data</button>
                <button id="process-data">Process Data</button>
                <button id="clear-local-storage">Clear localStorage</button>
                <button id="initialize-app">Initialize App</button>
            </div>
        </div>
        
        <div>
            <h2 class="text-xl font-semibold mb-2">Status</h2>
            <div id="status" class="p-4 bg-gray-100 rounded-lg min-h-[100px]">
                Ready
            </div>
        </div>
    </div>
    
    <div class="mb-6">
        <h2 class="text-xl font-semibold mb-2">State</h2>
        <pre id="state-output" class="max-h-[400px] overflow-auto"></pre>
    </div>
    
    <script type="module">
        import * as state from '../js/state.js';
        import * as weekDataManager from '../js/weekDataManager.js';
        import * as dataProcessing from '../js/dataProcessing.js';
        
        document.getElementById('check-state').addEventListener('click', async () => {
            updateStatus('Checking state...');
            const allState = state.getAllState();
            document.getElementById('state-output').textContent = JSON.stringify(allState, null, 2);
            updateStatus('State fetched successfully');
        });
        
        document.getElementById('load-fallback-weeks').addEventListener('click', async () => {
            updateStatus('Loading fallback weeks...');
            
            // Create fallback weeks data
            const fallbackWeeks = [
                { week: '12', file: 'data_week_12.csv' },
                { week: '13', file: 'data_week_13.csv' },
                { week: '14', file: 'data_week_14.csv' },
                { week: '15', file: 'data_week_15.csv' }
            ];
            
            // Use setState to update state
            state.setState('availableWeeks', fallbackWeeks);
            
            // Verify the state was updated
            const updatedWeeks = state.getState('availableWeeks');
            updateStatus(`Added ${updatedWeeks.length} fallback weeks`);
            
            // Update state display
            document.getElementById('state-output').textContent = JSON.stringify(state.getAllState(), null, 2);
        });
        
        document.getElementById('load-csv').addEventListener('click', async () => {
            updateStatus('Loading CSV data...');
            try {
                const availableWeeks = state.getState('availableWeeks');
                if (!availableWeeks || availableWeeks.length === 0) {
                    throw new Error('No available weeks - load fallback weeks first');
                }
                
                // Get most recent week
                const mostRecentWeek = weekDataManager.getMostRecentWeek();
                if (!mostRecentWeek) {
                    throw new Error('Could not determine most recent week');
                }
                
                // Load data for most recent week
                updateStatus(`Loading data for week ${mostRecentWeek.week}...`);
                const loaded = await weekDataManager.loadWeekData(mostRecentWeek.file);
                
                if (loaded) {
                    updateStatus(`Data loaded successfully for week ${mostRecentWeek.week}`);
                    // Update state display with first 3 players (to keep it manageable)
                    const allState = state.getAllState();
                    if (allState.playerData && allState.playerData.length > 3) {
                        allState.playerData = allState.playerData.slice(0, 3) + '... [truncated]';
                    }
                    document.getElementById('state-output').textContent = JSON.stringify(allState, null, 2);
                } else {
                    throw new Error(`Failed to load data for week ${mostRecentWeek.week}`);
                }
            } catch (error) {
                updateStatus(`Error: ${error.message}`, true);
            }
        });
        
        document.getElementById('process-data').addEventListener('click', async () => {
            updateStatus('Processing data...');
            try {
                const result = dataProcessing.processPlayerData();
                if (result) {
                    updateStatus('Data processed successfully');
                    
                    // Display stats about the processed data
                    const displayData = state.getState('displayData') || [];
                    updateStatus(`Processed ${displayData.length} players`);
                    
                    // Update state display (only show first 3 players to keep it manageable)
                    const allState = state.getAllState();
                    if (allState.displayData && allState.displayData.length > 3) {
                        const tempState = {...allState};
                        tempState.displayData = allState.displayData.slice(0, 3);
                        tempState.displayData.push('... [truncated]');
                        document.getElementById('state-output').textContent = JSON.stringify(tempState, null, 2);
                    } else {
                        document.getElementById('state-output').textContent = JSON.stringify(allState, null, 2);
                    }
                } else {
                    throw new Error('Data processing failed');
                }
            } catch (error) {
                updateStatus(`Error: ${error.message}`, true);
            }
        });
        
        document.getElementById('clear-local-storage').addEventListener('click', () => {
            updateStatus('Clearing localStorage...');
            localStorage.clear();
            updateStatus('localStorage cleared');
        });
        
        document.getElementById('initialize-app').addEventListener('click', async () => {
            updateStatus('Initializing application...');
            try {
                // Initialize state
                state.initialize();
                updateStatus('State initialized');
                
                // Create default state with fallbacks
                state.createDefaultState();
                updateStatus('Default state created with fallbacks');
                
                // Update state display
                document.getElementById('state-output').textContent = JSON.stringify(state.getAllState(), null, 2);
                
                // Initialize weekly data
                updateStatus('Initializing weekly data...');
                const weekDataInitialized = await weekDataManager.initializeWeeklyData();
                
                if (weekDataInitialized) {
                    updateStatus('Weekly data initialized successfully');
                } else {
                    throw new Error('Failed to initialize weekly data');
                }
                
                // Process player data
                updateStatus('Processing player data...');
                const dataProcessed = dataProcessing.processPlayerData();
                
                if (dataProcessed) {
                    updateStatus('Player data processed successfully');
                } else {
                    throw new Error('Failed to process player data');
                }
                
                // Show final state
                const allState = state.getAllState();
                // Truncate large arrays for display
                const displayState = {...allState};
                if (displayState.playerData && displayState.playerData.length > 3) {
                    displayState.playerData = displayState.playerData.slice(0, 3);
                    displayState.playerData.push('... [truncated]');
                }
                if (displayState.displayData && displayState.displayData.length > 3) {
                    displayState.displayData = displayState.displayData.slice(0, 3);
                    displayState.displayData.push('... [truncated]');
                }
                
                document.getElementById('state-output').textContent = JSON.stringify(displayState, null, 2);
                updateStatus('Application initialized successfully');
            } catch (error) {
                updateStatus(`Error: ${error.message}`, true);
            }
        });
        
        function updateStatus(message, isError = false) {
            const statusElement = document.getElementById('status');
            const timestamp = new Date().toLocaleTimeString();
            statusElement.innerHTML += `<div class="${isError ? 'text-red-600' : ''}">[${timestamp}] ${message}</div>`;
            statusElement.scrollTop = statusElement.scrollHeight;
        }
    </script>
</body>
</html> 