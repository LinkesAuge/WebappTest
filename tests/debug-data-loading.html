<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Data Loading</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        h1, h2 {
            color: #333;
        }
        button {
            padding: 10px 15px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background-color: #45a049;
        }
        pre {
            background-color: #f8f8f8;
            padding: 15px;
            border-radius: 5px;
            overflow: auto;
            max-height: 400px;
            border: 1px solid #ddd;
            font-family: monospace;
            font-size: 14px;
        }
        .step {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .success {
            color: green;
            font-weight: bold;
        }
        .error {
            color: red;
            font-weight: bold;
        }
        .info {
            color: blue;
        }
        #log {
            background-color: #f8f8f8;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
        }
        .log-entry {
            margin-bottom: 5px;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }
        #network-log {
            background-color: #f8f8f8;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
        }
        .network-entry {
            margin-bottom: 5px;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }
        .method {
            font-weight: bold;
            display: inline-block;
            width: 70px;
        }
        .status {
            font-weight: bold;
            margin-left: 10px;
        }
        .status-200 {
            color: green;
        }
        .status-404 {
            color: red;
        }
        .url {
            margin-left: 10px;
            color: #555;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Debug ChefScore Data Loading Issues</h1>
        <p>This page provides detailed debugging for the data loading process.</p>
        
        <div class="step">
            <h2>Step 1: Check Configuration</h2>
            <button id="check-config">Check Configuration</button>
            <pre id="config-output">Click button to check configuration...</pre>
        </div>
        
        <div class="step">
            <h2>Step 2: Check File Paths</h2>
            <button id="check-paths">Check File Paths</button>
            <pre id="paths-output">Click button to check paths...</pre>
        </div>
        
        <div class="step">
            <h2>Step 3: Load weeks.json</h2>
            <button id="load-weeks">Load weeks.json</button>
            <pre id="weeks-output">Click button to load weeks.json...</pre>
        </div>
        
        <div class="step">
            <h2>Step 4: Load Weekly Data</h2>
            <p>This will attempt to load data for the first week in weeks.json.</p>
            <button id="load-week-data">Load Week Data</button>
            <pre id="week-data-output">Click button to load week data...</pre>
        </div>
        
        <div class="step">
            <h2>Step 5: Full Data Loading Sequence</h2>
            <p>This simulates the entire data loading sequence as it would happen in the application.</p>
            <button id="full-sequence">Run Full Sequence</button>
            <pre id="full-sequence-output">Click button to run full sequence...</pre>
        </div>
        
        <div class="step">
            <h2>Step 6: Verify DOM Elements</h2>
            <p>Check if all required DOM elements are available for the weekly data system.</p>
            <button id="check-dom">Check DOM Elements</button>
            <pre id="dom-output">Click button to check DOM elements...</pre>
        </div>
        
        <div id="log">
            <h2>Debug Log</h2>
            <div id="log-entries"></div>
        </div>
        
        <div id="network-log">
            <h2>Network Log</h2>
            <div id="network-entries"></div>
        </div>
    </div>
    
    <script type="module">
        import * as config from '../js/config.js';
        import * as state from '../js/state.js';
        import * as dataLoading from '../js/dataLoading.js';
        import * as weekDataManager from '../js/weekDataManager.js';
        import * as dom from '../js/dom.js';
        
        // Overwrite console methods to display in our debug UI
        const originalConsoleLog = console.log;
        const originalConsoleError = console.error;
        const originalConsoleWarn = console.warn;
        
        console.log = function(message) {
            logToUI('log', message);
            originalConsoleLog.apply(console, arguments);
        };
        
        console.error = function(message) {
            logToUI('error', message);
            originalConsoleError.apply(console, arguments);
        };
        
        console.warn = function(message) {
            logToUI('warning', message);
            originalConsoleWarn.apply(console, arguments);
        };
        
        function logToUI(level, message) {
            const logEntries = document.getElementById('log-entries');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            
            if (typeof message === 'object') {
                try {
                    message = JSON.stringify(message, null, 2);
                } catch (e) {
                    message = 'Object (could not stringify)';
                }
            }
            
            entry.innerHTML = `<span class="${level}">[${level.toUpperCase()}]</span> ${message}`;
            logEntries.appendChild(entry);
            logEntries.parentElement.scrollTop = logEntries.parentElement.scrollHeight;
        }
        
        // Monitor network requests
        const originalFetch = window.fetch;
        window.fetch = function(url, options) {
            const startTime = new Date();
            const method = options && options.method ? options.method : 'GET';
            
            logNetworkRequest(method, url, 'PENDING');
            
            return originalFetch.apply(this, arguments)
                .then(response => {
                    const endTime = new Date();
                    const duration = endTime - startTime;
                    logNetworkRequest(method, url, response.status, duration);
                    return response;
                })
                .catch(error => {
                    const endTime = new Date();
                    const duration = endTime - startTime;
                    logNetworkRequest(method, url, 'ERROR', duration, error.message);
                    throw error;
                });
        };
        
        function logNetworkRequest(method, url, status, duration, errorMessage) {
            const networkEntries = document.getElementById('network-entries');
            
            // Find existing request entry or create new one
            let entry = Array.from(networkEntries.children).find(
                el => el.dataset.url === url && el.dataset.method === method
            );
            
            if (!entry) {
                entry = document.createElement('div');
                entry.className = 'network-entry';
                entry.dataset.url = url;
                entry.dataset.method = method;
                networkEntries.appendChild(entry);
            }
            
            // Update entry
            let statusClass = 'status-' + status;
            if (status === 'PENDING') {
                statusClass = 'info';
            } else if (status !== 200) {
                statusClass = 'status-404';
            }
            
            let content = `<span class="method">${method}</span>`;
            content += `<span class="status ${statusClass}">${status}</span>`;
            content += `<span class="url">${url}</span>`;
            
            if (duration) {
                content += `<span class="duration">(${duration}ms)</span>`;
            }
            
            if (errorMessage) {
                content += `<div class="error-message">${errorMessage}</div>`;
            }
            
            entry.innerHTML = content;
            networkEntries.parentElement.scrollTop = networkEntries.parentElement.scrollHeight;
        }
        
        // Step 1: Check Configuration
        document.getElementById('check-config').addEventListener('click', () => {
            try {
                const configOutput = document.getElementById('config-output');
                
                const configValues = {
                    RULES_PATH: config.RULES_PATH,
                    DATA_FOLDER_PATH: config.DATA_FOLDER_PATH,
                    WEEKS_JSON_PATH: config.WEEKS_JSON_PATH
                };
                
                // Check if old CSV_PATH exists
                const hasCSV_PATH = 'CSV_PATH' in config;
                
                const result = {
                    configValues,
                    diagnostics: {
                        hasCSV_PATH,
                        hasFolderPath: !!config.DATA_FOLDER_PATH,
                        hasWeeksPath: !!config.WEEKS_JSON_PATH,
                        hasRulesPath: !!config.RULES_PATH
                    }
                };
                
                configOutput.textContent = JSON.stringify(result, null, 2);
                console.log('Configuration check completed');
            } catch (error) {
                console.error('Error checking configuration:', error);
            }
        });
        
        // Step 2: Check File Paths
        document.getElementById('check-paths').addEventListener('click', async () => {
            try {
                const pathsOutput = document.getElementById('paths-output');
                
                const paths = [
                    config.RULES_PATH,
                    config.WEEKS_JSON_PATH,
                    `${config.DATA_FOLDER_PATH}/data_week_12.csv`,
                    `${config.DATA_FOLDER_PATH}/data_week_13.csv`,
                    `${config.DATA_FOLDER_PATH}/data_week_14.csv`,
                    `${config.DATA_FOLDER_PATH}/data_week_15.csv`
                ];
                
                const results = {};
                
                for (const path of paths) {
                    try {
                        console.log(`Checking path: ${path}`);
                        const response = await fetch(path, { method: 'HEAD' });
                        results[path] = {
                            exists: response.ok,
                            status: response.status
                        };
                    } catch (error) {
                        results[path] = {
                            exists: false,
                            error: error.message
                        };
                    }
                }
                
                pathsOutput.textContent = JSON.stringify(results, null, 2);
                console.log('Path check completed');
            } catch (error) {
                console.error('Error checking paths:', error);
            }
        });
        
        // Step 3: Load weeks.json
        document.getElementById('load-weeks').addEventListener('click', async () => {
            try {
                const weeksOutput = document.getElementById('weeks-output');
                
                console.log('Loading weeks.json...');
                
                // Clear existing weeks
                if (state.availableWeeks) {
                    state.availableWeeks.length = 0;
                }
                
                // Attempt to load weeks.json directly
                try {
                    const response = await fetch(config.WEEKS_JSON_PATH);
                    if (response.ok) {
                        console.log('weeks.json fetch successful');
                        const weeksData = await response.json();
                        
                        console.log('weeks.json parsed successfully:', weeksData);
                        
                        // Process weeks data
                        if (Array.isArray(weeksData) && weeksData.length > 0) {
                            // Ensure availableWeeks array exists
                            if (!state.availableWeeks) {
                                state.availableWeeks = [];
                            }
                            
                            // Add week data
                            weeksData.forEach(week => {
                                if (week && week.week && week.file) {
                                    state.availableWeeks.push({
                                        week: week.week,
                                        file: week.file
                                    });
                                }
                            });
                            
                            console.log(`Loaded ${state.availableWeeks.length} weeks`);
                        } else {
                            console.error('weeks.json contains no valid data');
                        }
                    } else {
                        console.error(`Error fetching weeks.json: ${response.status} ${response.statusText}`);
                    }
                } catch (error) {
                    console.error('Error loading weeks.json:', error);
                }
                
                // Check if we have available weeks
                if (!state.availableWeeks || state.availableWeeks.length === 0) {
                    console.warn('No available weeks, using fallback data');
                    
                    // Create fallback weeks
                    if (!state.availableWeeks) {
                        state.availableWeeks = [];
                    }
                    
                    // Add fallback weeks
                    state.availableWeeks.push(
                        { week: '12', file: 'data_week_12.csv' },
                        { week: '13', file: 'data_week_13.csv' },
                        { week: '14', file: 'data_week_14.csv' },
                        { week: '15', file: 'data_week_15.csv' }
                    );
                    
                    console.log('Created fallback weeks data:', state.availableWeeks);
                }
                
                // Display result
                weeksOutput.textContent = JSON.stringify({
                    success: state.availableWeeks && state.availableWeeks.length > 0,
                    availableWeeks: state.availableWeeks,
                    weekCount: state.availableWeeks ? state.availableWeeks.length : 0
                }, null, 2);
            } catch (error) {
                console.error('Error in weeks.json loading test:', error);
                weeksOutput.textContent = JSON.stringify({
                    success: false,
                    error: error.message
                }, null, 2);
            }
        });
        
        // Step 4: Load Weekly Data
        document.getElementById('load-week-data').addEventListener('click', async () => {
            try {
                const weekDataOutput = document.getElementById('week-data-output');
                
                // Check if we have available weeks
                if (!state.availableWeeks || state.availableWeeks.length === 0) {
                    console.warn('No available weeks, loading them first...');
                    
                    // Load weeks
                    document.getElementById('load-weeks').click();
                    
                    // Wait a moment for weeks to load
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                    if (!state.availableWeeks || state.availableWeeks.length === 0) {
                        console.error('Failed to load weeks, cannot proceed with week data loading');
                        weekDataOutput.textContent = JSON.stringify({
                            success: false,
                            error: 'No available weeks to load'
                        }, null, 2);
                        return;
                    }
                }
                
                // Get the first week
                const firstWeek = state.availableWeeks[0];
                console.log(`Loading data for week ${firstWeek.week} from file ${firstWeek.file}...`);
                
                // Load week data
                try {
                    // Build full file path
                    const filePath = `${config.DATA_FOLDER_PATH}/${firstWeek.file}`;
                    console.log(`Full file path: ${filePath}`);
                    
                    // Fetch the file
                    const response = await fetch(filePath);
                    if (response.ok) {
                        console.log('Week data fetch successful');
                        
                        const csvText = await response.text();
                        console.log(`Loaded ${csvText.length} characters of CSV data`);
                        
                        // Parse the CSV
                        if (csvText && csvText.length > 0) {
                            // Use weekDataManager's parseWeekCsv function if available
                            let parsedData;
                            if (typeof weekDataManager.parseWeekCsv === 'function') {
                                parsedData = weekDataManager.parseWeekCsv(csvText);
                                console.log('Used weekDataManager.parseWeekCsv for parsing');
                            } else {
                                // Fallback to manual parsing
                                console.warn('weekDataManager.parseWeekCsv not available, using fallback parsing');
                                parsedData = parseCSV(csvText);
                            }
                            
                            if (parsedData && parsedData.length > 0) {
                                console.log(`Parsed ${parsedData.length} player records`);
                                
                                // Save data
                                state.playerData = parsedData;
                                
                                // Set current week
                                state.currentWeek = firstWeek;
                                state.currentWeekNumber = firstWeek.week;
                                
                                weekDataOutput.textContent = JSON.stringify({
                                    success: true,
                                    weekData: {
                                        week: firstWeek.week,
                                        file: firstWeek.file,
                                        recordCount: parsedData.length,
                                        sampleRecords: parsedData.slice(0, 3)
                                    }
                                }, null, 2);
                            } else {
                                console.error('Failed to parse week data or no data in file');
                                weekDataOutput.textContent = JSON.stringify({
                                    success: false,
                                    error: 'Failed to parse week data or no data in file'
                                }, null, 2);
                            }
                        } else {
                            console.error('Week data file is empty');
                            weekDataOutput.textContent = JSON.stringify({
                                success: false,
                                error: 'Week data file is empty'
                            }, null, 2);
                        }
                    } else {
                        console.error(`Error fetching week data: ${response.status} ${response.statusText}`);
                        weekDataOutput.textContent = JSON.stringify({
                            success: false,
                            error: `Error fetching week data: ${response.status} ${response.statusText}`
                        }, null, 2);
                    }
                } catch (error) {
                    console.error('Error loading week data:', error);
                    weekDataOutput.textContent = JSON.stringify({
                        success: false,
                        error: error.message
                    }, null, 2);
                }
            } catch (error) {
                console.error('Error in week data loading test:', error);
                weekDataOutput.textContent = JSON.stringify({
                    success: false,
                    error: error.message
                }, null, 2);
            }
        });
        
        // Step 5: Full Data Loading Sequence
        document.getElementById('full-sequence').addEventListener('click', async () => {
            try {
                const fullSequenceOutput = document.getElementById('full-sequence-output');
                fullSequenceOutput.textContent = 'Running full sequence...';
                
                console.log('Starting full data loading sequence');
                
                // Reset state
                state.resetState();
                console.log('State reset');
                
                // Step 1: Load score rules
                console.log('Step 1: Loading score rules...');
                const rulesLoaded = await dataLoading.loadScoreRules();
                console.log(`Score rules loaded: ${rulesLoaded}`);
                
                // Step 2: Load available weeks
                console.log('Step 2: Loading available weeks...');
                const weeksLoaded = await dataLoading.loadAvailableWeeks();
                console.log(`Available weeks loaded: ${weeksLoaded}`);
                
                // Create mock DOM elements for testing
                createMockDomElements();
                
                // Step 3: Initialize weekly data
                console.log('Step 3: Initializing weekly data...');
                const weeklyDataInitialized = await weekDataManager.initializeWeeklyData();
                console.log(`Weekly data initialized: ${weeklyDataInitialized}`);
                
                // Gather results
                const result = {
                    rulesLoaded,
                    weeksLoaded,
                    weeklyDataInitialized,
                    state: {
                        scoreRules: state.scoreRules ? state.scoreRules.length : 0,
                        availableWeeks: state.availableWeeks ? state.availableWeeks.length : 0,
                        currentWeek: state.currentWeek,
                        playerData: state.playerData ? state.playerData.length : 0,
                        allPlayersData: state.allPlayersData ? state.allPlayersData.length : 0,
                        displayData: state.displayData ? state.displayData.length : 0
                    }
                };
                
                fullSequenceOutput.textContent = JSON.stringify(result, null, 2);
                console.log('Full sequence completed', result);
            } catch (error) {
                console.error('Error in full sequence test:', error);
                document.getElementById('full-sequence-output').textContent = JSON.stringify({
                    success: false,
                    error: error.message,
                    stack: error.stack
                }, null, 2);
            }
        });
        
        // Step 6: Verify DOM Elements
        document.getElementById('check-dom').addEventListener('click', () => {
            try {
                const domOutput = document.getElementById('dom-output');
                
                // First gather information about the existing DOM elements
                const elements = {
                    weekSelector: document.getElementById('weekSelector'),
                    mobileWeekSelector: document.getElementById('mobileWeekSelector'),
                    prevWeekBtn: document.getElementById('prevWeekBtn'),
                    nextWeekBtn: document.getElementById('nextWeekBtn'),
                    weekSelectorContainer: document.getElementById('weekSelectorContainer'),
                    historySection: document.getElementById('historySection')
                };
                
                // Check which elements exist
                const elementStatus = {};
                for (const [id, element] of Object.entries(elements)) {
                    elementStatus[id] = !!element;
                }
                
                // Create mock elements if needed
                const createdElements = [];
                for (const [id, exists] of Object.entries(elementStatus)) {
                    if (!exists) {
                        const mockElement = document.createElement('div');
                        mockElement.id = id;
                        document.body.appendChild(mockElement);
                        createdElements.push(id);
                    }
                }
                
                // Make sure DOM module has the references
                dom.assignElementReferences();
                
                // Check if weekDataManager can find the elements
                const weekSelector = document.getElementById('weekSelector');
                const canUpdateSelector = weekSelector && typeof weekDataManager.updateWeekSelector === 'function';
                
                const result = {
                    originalElements: elementStatus,
                    createdMockElements: createdElements,
                    domReferences: {
                        hasAssignElementReferences: typeof dom.assignElementReferences === 'function',
                        hasWeekSelectorInDom: !!dom.elements.weekSelector,
                        hasMobileWeekSelectorInDom: !!dom.elements.mobileWeekSelector
                    },
                    weekDataManager: {
                        canUpdateSelector,
                        hasUpdateWeekSelector: typeof weekDataManager.updateWeekSelector === 'function',
                        hasChangeWeek: typeof weekDataManager.changeWeek === 'function',
                        hasInitializeWeeklyData: typeof weekDataManager.initializeWeeklyData === 'function'
                    }
                };
                
                domOutput.textContent = JSON.stringify(result, null, 2);
                console.log('DOM check completed');
            } catch (error) {
                console.error('Error checking DOM:', error);
                document.getElementById('dom-output').textContent = JSON.stringify({
                    success: false,
                    error: error.message
                }, null, 2);
            }
        });
        
        // Helper functions
        function createMockDomElements() {
            const requiredElements = [
                'weekSelector', 'mobileWeekSelector', 'prevWeekBtn', 'nextWeekBtn',
                'weekSelectorContainer', 'historySection', 'rankingSection', 'rankingTableBody'
            ];
            
            const createdElements = [];
            
            for (const id of requiredElements) {
                if (!document.getElementById(id)) {
                    const mockElement = document.createElement('div');
                    mockElement.id = id;
                    document.body.appendChild(mockElement);
                    createdElements.push(id);
                }
            }
            
            if (createdElements.length > 0) {
                console.log(`Created mock DOM elements: ${createdElements.join(', ')}`);
                
                // Re-assign DOM references
                dom.assignElementReferences();
            }
            
            return createdElements;
        }
        
        // Simple CSV parser as fallback
        function parseCSV(csv) {
            if (!csv || typeof csv !== 'string') {
                console.error('Invalid CSV input');
                return [];
            }
            
            // Split into rows
            const rows = csv.split(/\r?\n/).filter(row => row.trim());
            if (rows.length === 0) {
                console.warn('CSV has no rows');
                return [];
            }
            
            // Parse headers (first row)
            const headers = rows[0].split(',').map(header => header.trim());
            
            // Parse data rows
            const data = [];
            for (let i = 1; i < rows.length; i++) {
                const rowData = {};
                const values = rows[i].split(',');
                
                // Skip empty rows
                if (values.length === 1 && !values[0].trim()) {
                    continue;
                }
                
                // Map values to headers
                headers.forEach((header, index) => {
                    // Convert numeric values to numbers
                    const value = values[index] ? values[index].trim() : '';
                    rowData[header] = !isNaN(value) && value !== '' ? Number(value) : value;
                });
                
                data.push(rowData);
            }
            
            return data;
        }
        
        console.log('Debug page initialized and ready');
    </script>
</body>
</html> 