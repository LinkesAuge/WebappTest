<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weekly Data Loading Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            line-height: 1.6;
        }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        .warning { color: orange; }
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        button {
            padding: 8px 16px;
            margin: 5px;
            cursor: pointer;
        }
        #logs {
            border: 1px solid #ccc;
            padding: 10px;
            margin-top: 20px;
            min-height: 300px;
            max-height: 500px;
            overflow-y: auto;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .test-group {
            margin-bottom: 20px;
            padding: 10px;
            border: 1px dashed #ccc;
            border-radius: 5px;
        }
        .test-title {
            font-weight: bold;
            margin-bottom: 10px;
        }
        .test-controls {
            display: flex;
            flex-wrap: wrap;
        }
        .summary {
            margin-top: 20px;
            padding: 10px;
            background-color: #f5f5f5;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Weekly Data Loading Test</h1>
        <p>This test verifies the weekly data loading functionality with thorough error handling and validation.</p>
        
        <div class="test-group">
            <div class="test-title">Configuration Tests</div>
            <div class="test-controls">
                <button id="test-config">Test Configuration</button>
                <button id="test-file-exists">Test File Existence</button>
            </div>
        </div>
        
        <div class="test-group">
            <div class="test-title">Data Loading Tests</div>
            <div class="test-controls">
                <button id="test-weeks-json">Test weeks.json Loading</button>
                <button id="test-rules-csv">Test rules.csv Loading</button>
                <button id="test-week-data">Test Week Data Loading</button>
                <button id="test-week-switching">Test Week Switching</button>
            </div>
        </div>
        
        <div class="test-group">
            <div class="test-title">Error Handling Tests</div>
            <div class="test-controls">
                <button id="test-missing-file">Test Missing File Handling</button>
                <button id="test-invalid-data">Test Invalid Data Handling</button>
                <button id="test-fallback-data">Test Fallback Data</button>
            </div>
        </div>
        
        <div class="test-group">
            <div class="test-title">UI Integration Tests</div>
            <div class="test-controls">
                <button id="test-week-selector">Test Week Selector</button>
                <button id="test-data-processing">Test Data Processing</button>
                <button id="test-ui-updates">Test UI Updates</button>
            </div>
        </div>
        
        <div class="controls">
            <button id="run-all-tests">Run All Tests</button>
            <button id="clear-logs">Clear Logs</button>
        </div>
        
        <div class="summary" id="test-summary">
            Tests not yet run
        </div>
        
        <div id="logs"></div>
    </div>

    <script type="module">
        // Import necessary modules from our application
        import config from '../js/config.js';
        import * as state from '../js/state.js';
        import * as dataLoading from '../js/dataLoading.js';
        import * as weekDataManager from '../js/weekDataManager.js';
        import * as dom from '../js/dom.js';
        import * as dataProcessing from '../js/data-processing/dataProcessing.js';
        import * as uiUpdates from '../js/uiUpdates.js';
        
        // Test tracking
        const testResults = {
            passed: 0,
            failed: 0,
            total: 0
        };
        
        // Get DOM elements
        const logsElement = document.getElementById('logs');
        const summaryElement = document.getElementById('test-summary');
        
        // Logging function
        function log(message, type = 'info') {
            const line = document.createElement('div');
            line.className = type;
            line.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logsElement.appendChild(line);
            logsElement.scrollTop = logsElement.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
        
        // Test result handler
        function recordTestResult(testName, success, message) {
            testResults.total++;
            if (success) {
                testResults.passed++;
                log(`✅ PASS: ${testName} - ${message}`, 'success');
            } else {
                testResults.failed++;
                log(`❌ FAIL: ${testName} - ${message}`, 'error');
            }
            
            // Update summary
            summaryElement.innerHTML = `
                Tests: ${testResults.total} | 
                Passed: ${testResults.passed} | 
                Failed: ${testResults.failed} | 
                Success Rate: ${Math.round((testResults.passed / testResults.total) * 100)}%
            `;
        }
        
        // File existence checker
        async function checkFileExists(url) {
            try {
                const response = await fetch(url, { method: 'HEAD' });
                return response.ok;
            } catch (error) {
                return false;
            }
        }
        
        // Configuration test
        document.getElementById('test-config').addEventListener('click', () => {
            log('Testing configuration...', 'info');
            
            try {
                // Check that CSV_PATH doesn't exist
                const hasCSV_PATH = 'CSV_PATH' in config;
                recordTestResult(
                    'Config No CSV_PATH', 
                    !hasCSV_PATH,
                    hasCSV_PATH ? 'CSV_PATH should not exist in config' : 'CSV_PATH correctly removed from config'
                );
                
                // Check required paths
                recordTestResult(
                    'Config RULES_PATH', 
                    !!config.RULES_PATH,
                    config.RULES_PATH ? `RULES_PATH set to ${config.RULES_PATH}` : 'RULES_PATH missing'
                );
                
                recordTestResult(
                    'Config DATA_FOLDER_PATH', 
                    !!config.DATA_FOLDER_PATH,
                    config.DATA_FOLDER_PATH ? `DATA_FOLDER_PATH set to ${config.DATA_FOLDER_PATH}` : 'DATA_FOLDER_PATH missing'
                );
                
                recordTestResult(
                    'Config WEEKS_JSON_PATH', 
                    !!config.WEEKS_JSON_PATH,
                    config.WEEKS_JSON_PATH ? `WEEKS_JSON_PATH set to ${config.WEEKS_JSON_PATH}` : 'WEEKS_JSON_PATH missing'
                );
                
                log('Configuration test completed', 'info');
            } catch (error) {
                log(`Configuration test error: ${error.message}`, 'error');
                console.error(error);
                recordTestResult('Config Test', false, `Error: ${error.message}`);
            }
        });
        
        // File existence test
        document.getElementById('test-file-exists').addEventListener('click', async () => {
            log('Testing file existence...', 'info');
            
            try {
                // Check rules.csv exists
                const rulesExists = await checkFileExists(config.RULES_PATH);
                recordTestResult(
                    'File Exists: rules.csv', 
                    rulesExists,
                    rulesExists ? 'rules.csv file exists' : 'rules.csv file not found'
                );
                
                // Check weeks.json exists
                const weeksJsonExists = await checkFileExists(config.WEEKS_JSON_PATH);
                recordTestResult(
                    'File Exists: weeks.json', 
                    weeksJsonExists,
                    weeksJsonExists ? 'weeks.json file exists' : 'weeks.json file not found'
                );
                
                log('File existence test completed', 'info');
            } catch (error) {
                log(`File existence test error: ${error.message}`, 'error');
                console.error(error);
                recordTestResult('File Existence Test', false, `Error: ${error.message}`);
            }
        });
        
        // Weeks JSON loading test
        document.getElementById('test-weeks-json').addEventListener('click', async () => {
            log('Testing weeks.json loading...', 'info');
            
            try {
                // Clear existing weeks
                if (state.availableWeeks) {
                    state.availableWeeks.length = 0;
                }
                
                // Load weeks
                const result = await dataLoading.loadAvailableWeeks();
                recordTestResult(
                    'Load Weeks JSON', 
                    result,
                    result ? 'Successfully loaded weeks.json' : 'Failed to load weeks.json'
                );
                
                // Check available weeks array
                const hasWeeks = state.availableWeeks && state.availableWeeks.length > 0;
                recordTestResult(
                    'Weeks Array Populated', 
                    hasWeeks,
                    hasWeeks ? `Loaded ${state.availableWeeks.length} weeks` : 'No weeks loaded'
                );
                
                // Validate week data structure
                if (hasWeeks) {
                    const firstWeek = state.availableWeeks[0];
                    const hasRequiredProps = firstWeek && 'week' in firstWeek && 'file' in firstWeek;
                    
                    recordTestResult(
                        'Week Data Structure', 
                        hasRequiredProps,
                        hasRequiredProps ? 'Week objects have required properties' : 'Week objects missing required properties'
                    );
                    
                    // Log available weeks
                    state.availableWeeks.forEach(week => {
                        log(`Week ${week.week}: ${week.file}`, 'info');
                    });
                }
                
                log('Weeks JSON test completed', 'info');
            } catch (error) {
                log(`Weeks JSON test error: ${error.message}`, 'error');
                console.error(error);
                recordTestResult('Weeks JSON Test', false, `Error: ${error.message}`);
            }
        });
        
        // Rules CSV loading test
        document.getElementById('test-rules-csv').addEventListener('click', async () => {
            log('Testing rules.csv loading...', 'info');
            
            try {
                // Clear existing rules
                if (state.scoreRules) {
                    state.scoreRules.length = 0;
                }
                
                // Load rules
                const result = await dataLoading.loadScoreRules();
                recordTestResult(
                    'Load Rules CSV', 
                    result,
                    result ? 'Successfully loaded rules.csv' : 'Failed to load rules.csv'
                );
                
                // Check rules array
                const hasRules = state.scoreRules && state.scoreRules.length > 0;
                recordTestResult(
                    'Rules Array Populated', 
                    hasRules,
                    hasRules ? `Loaded ${state.scoreRules.length} rules` : 'No rules loaded'
                );
                
                // Validate rule data structure
                if (hasRules) {
                    const firstRule = state.scoreRules[0];
                    const hasRequiredProps = firstRule && 
                                         'Typ' in firstRule && 
                                         'Stufe' in firstRule && 
                                         'Punkte' in firstRule;
                    
                    recordTestResult(
                        'Rule Data Structure', 
                        hasRequiredProps,
                        hasRequiredProps ? 'Rule objects have required properties' : 'Rule objects missing required properties'
                    );
                    
                    // Log first few rules
                    state.scoreRules.slice(0, 3).forEach(rule => {
                        log(`Rule: ${rule.Typ}, Level: ${rule.Stufe}, Points: ${rule.Punkte}`, 'info');
                    });
                    
                    if (state.scoreRules.length > 3) {
                        log(`... and ${state.scoreRules.length - 3} more rules`, 'info');
                    }
                }
                
                log('Rules CSV test completed', 'info');
            } catch (error) {
                log(`Rules CSV test error: ${error.message}`, 'error');
                console.error(error);
                recordTestResult('Rules CSV Test', false, `Error: ${error.message}`);
            }
        });
        
        // Week data loading test
        document.getElementById('test-week-data').addEventListener('click', async () => {
            log('Testing week data loading...', 'info');
            
            try {
                // First ensure we have available weeks
                if (!state.availableWeeks || state.availableWeeks.length === 0) {
                    log('Loading available weeks first...', 'info');
                    await dataLoading.loadAvailableWeeks();
                }
                
                // Check if we have weeks
                if (!state.availableWeeks || state.availableWeeks.length === 0) {
                    log('No available weeks to test with', 'warning');
                    recordTestResult('Week Data Test', false, 'No available weeks to test with');
                    return;
                }
                
                // Initialize the weekly data system
                const initialized = await weekDataManager.initializeWeeklyData();
                recordTestResult(
                    'Initialize Weekly Data', 
                    initialized,
                    initialized ? 'Weekly data system initialized' : 'Failed to initialize weekly data system'
                );
                
                // Check current week
                const hasCurrentWeek = state.currentWeek && state.currentWeek.week;
                recordTestResult(
                    'Current Week Set', 
                    hasCurrentWeek,
                    hasCurrentWeek ? `Current week set to week ${state.currentWeek.week}` : 'Current week not set'
                );
                
                // Check player data
                const hasPlayerData = state.playerData && state.playerData.length > 0;
                recordTestResult(
                    'Player Data Loaded', 
                    hasPlayerData,
                    hasPlayerData ? `Loaded ${state.playerData.length} players` : 'No player data loaded'
                );
                
                // Log player data details if available
                if (hasPlayerData) {
                    state.playerData.slice(0, 3).forEach(player => {
                        const playerName = player.PLAYER || player.Name || 'Unknown';
                        log(`Player: ${playerName}, Score: ${player.TOTAL_SCORE || 'N/A'}, Chests: ${player.CHEST_COUNT || 'N/A'}`, 'info');
                    });
                    
                    if (state.playerData.length > 3) {
                        log(`... and ${state.playerData.length - 3} more players`, 'info');
                    }
                }
                
                log('Week data test completed', 'info');
            } catch (error) {
                log(`Week data test error: ${error.message}`, 'error');
                console.error(error);
                recordTestResult('Week Data Test', false, `Error: ${error.message}`);
            }
        });
        
        // Week switching test
        document.getElementById('test-week-switching').addEventListener('click', async () => {
            log('Testing week switching...', 'info');
            
            try {
                // First ensure we have available weeks
                if (!state.availableWeeks || state.availableWeeks.length === 0) {
                    log('Loading available weeks first...', 'info');
                    await dataLoading.loadAvailableWeeks();
                }
                
                // Check if we have at least 2 weeks
                if (!state.availableWeeks || state.availableWeeks.length < 2) {
                    log('Need at least 2 available weeks to test switching', 'warning');
                    recordTestResult('Week Switching Test', false, 'Not enough weeks available for testing');
                    return;
                }
                
                // Initialize weekly data if needed
                if (!state.currentWeek) {
                    log('Initializing weekly data first...', 'info');
                    await weekDataManager.initializeWeeklyData();
                }
                
                // Get the current week number
                const initialWeek = state.currentWeek ? state.currentWeek.week : null;
                
                if (!initialWeek) {
                    log('Current week not set, cannot test switching', 'warning');
                    recordTestResult('Week Switching Test', false, 'Current week not set');
                    return;
                }
                
                // Find a different week to switch to
                const targetWeek = state.availableWeeks.find(w => w.week !== initialWeek);
                
                if (!targetWeek) {
                    log('Could not find a different week to switch to', 'warning');
                    recordTestResult('Week Switching Test', false, 'No alternative week found');
                    return;
                }
                
                log(`Current week: ${initialWeek}, switching to week: ${targetWeek.week}`, 'info');
                
                // Switch to the target week
                const switched = await weekDataManager.changeWeek(targetWeek.week);
                recordTestResult(
                    'Week Change Function', 
                    switched,
                    switched ? `Successfully switched to week ${targetWeek.week}` : `Failed to switch to week ${targetWeek.week}`
                );
                
                // Verify the week was actually changed
                const weekChanged = state.currentWeek && state.currentWeek.week === targetWeek.week;
                recordTestResult(
                    'Week Actually Changed', 
                    weekChanged,
                    weekChanged ? `Current week is now ${state.currentWeek.week}` : 'Current week was not updated'
                );
                
                // Check if player data was updated
                const hasPlayerData = state.playerData && state.playerData.length > 0;
                recordTestResult(
                    'Player Data Updated', 
                    hasPlayerData,
                    hasPlayerData ? `Loaded ${state.playerData.length} players for week ${targetWeek.week}` : 'No player data loaded after week change'
                );
                
                // Switch back to the initial week
                log(`Switching back to initial week: ${initialWeek}`, 'info');
                const switchedBack = await weekDataManager.changeWeek(initialWeek);
                recordTestResult(
                    'Week Change Back', 
                    switchedBack,
                    switchedBack ? `Successfully switched back to week ${initialWeek}` : `Failed to switch back to week ${initialWeek}`
                );
                
                log('Week switching test completed', 'info');
            } catch (error) {
                log(`Week switching test error: ${error.message}`, 'error');
                console.error(error);
                recordTestResult('Week Switching Test', false, `Error: ${error.message}`);
            }
        });
        
        // Missing file handling test
        document.getElementById('test-missing-file').addEventListener('click', async () => {
            log('Testing missing file handling...', 'info');
            
            try {
                // Attempt to load a non-existent week file
                const nonExistentFile = 'non_existent_file.csv';
                log(`Testing loading non-existent file: ${nonExistentFile}`, 'info');
                
                // Try to load the non-existent file
                const result = await weekDataManager.loadWeekData(nonExistentFile);
                
                // This should fail gracefully
                recordTestResult(
                    'Missing File Graceful Failure', 
                    result === false,
                    result === false ? 'Correctly handled missing file' : 'Failed to handle missing file properly'
                );
                
                log('Missing file handling test completed', 'info');
            } catch (error) {
                log(`Missing file test error: ${error.message}`, 'error');
                console.error(error);
                recordTestResult('Missing File Test', false, `Error: ${error.message}`);
            }
        });
        
        // Invalid data handling test
        document.getElementById('test-invalid-data').addEventListener('click', async () => {
            log('Testing invalid data handling...', 'info');
            
            // This will need to be simulated since we don't want to create invalid files
            log('Note: This test simulates error handling by mocking functions', 'info');
            
            try {
                // Save original parse function to restore later
                const originalParseFunction = weekDataManager.parseWeekCsv;
                
                // Mock the parse function to return empty data
                weekDataManager.parseWeekCsv = (csvText) => {
                    log('Mocked parse function returning empty data', 'info');
                    return [];
                };
                
                // Try to load a valid file but with our mocked parse function
                if (state.availableWeeks && state.availableWeeks.length > 0) {
                    const testFile = state.availableWeeks[0].file;
                    log(`Testing with valid file but mocked parser: ${testFile}`, 'info');
                    
                    const result = await weekDataManager.loadWeekData(testFile);
                    
                    recordTestResult(
                        'Empty Data Graceful Handling', 
                        result === false,
                        result === false ? 'Correctly handled empty parsed data' : 'Failed to handle empty parsed data'
                    );
                } else {
                    log('No available weeks to test with', 'warning');
                    recordTestResult('Invalid Data Test', false, 'No available weeks to test with');
                }
                
                // Restore original function
                weekDataManager.parseWeekCsv = originalParseFunction;
                log('Restored original parse function', 'info');
                
                log('Invalid data handling test completed', 'info');
            } catch (error) {
                log(`Invalid data test error: ${error.message}`, 'error');
                console.error(error);
                recordTestResult('Invalid Data Test', false, `Error: ${error.message}`);
            }
        });
        
        // Fallback data test
        document.getElementById('test-fallback-data').addEventListener('click', async () => {
            log('Testing fallback data mechanism...', 'info');
            
            try {
                // Save original availableWeeks to restore later
                const originalWeeks = [...state.availableWeeks];
                
                // Clear availableWeeks
                state.availableWeeks = [];
                
                // Try loading again which should trigger fallback
                log('Cleared availableWeeks, attempting to reload...', 'info');
                
                // We're testing loadAvailableWeeks, but we need to simulate a failed fetch
                // This is tricky to test directly, so we'll check if the app adds fallback weeks
                
                // Add a check to see if any hardcoded weeks are added on initialization
                const initialWeeksCount = state.availableWeeks.length;
                
                // Call initializeWeeklyData which should trigger fallback data
                const result = await weekDataManager.initializeWeeklyData();
                
                // Check if fallback was triggered
                const fallbackTriggered = state.availableWeeks.length > initialWeeksCount;
                recordTestResult(
                    'Fallback Data Mechanism', 
                    fallbackTriggered,
                    fallbackTriggered ? `Fallback added ${state.availableWeeks.length} weeks` : 'Fallback mechanism not triggered'
                );
                
                // Restore original weeks
                state.availableWeeks = originalWeeks;
                log('Restored original available weeks', 'info');
                
                log('Fallback data test completed', 'info');
            } catch (error) {
                log(`Fallback data test error: ${error.message}`, 'error');
                console.error(error);
                recordTestResult('Fallback Data Test', false, `Error: ${error.message}`);
            }
        });
        
        // Week selector test
        document.getElementById('test-week-selector').addEventListener('click', async () => {
            log('Testing week selector...', 'info');
            
            try {
                // Create a mock selector
                const mockSelector = document.createElement('select');
                mockSelector.id = 'mockWeekSelector';
                document.body.appendChild(mockSelector);
                
                log('Created mock week selector', 'info');
                
                // Update the mock selector
                weekDataManager.updateWeekSelector(mockSelector);
                
                // Check if options were added
                const hasOptions = mockSelector.options.length > 0;
                recordTestResult(
                    'Week Selector Update', 
                    hasOptions,
                    hasOptions ? `Added ${mockSelector.options.length} options to selector` : 'No options added to selector'
                );
                
                // Clean up
                document.body.removeChild(mockSelector);
                log('Removed mock week selector', 'info');
                
                log('Week selector test completed', 'info');
            } catch (error) {
                log(`Week selector test error: ${error.message}`, 'error');
                console.error(error);
                recordTestResult('Week Selector Test', false, `Error: ${error.message}`);
                
                // Clean up in case of error
                const mockSelector = document.getElementById('mockWeekSelector');
                if (mockSelector) {
                    document.body.removeChild(mockSelector);
                }
            }
        });
        
        // Data processing test
        document.getElementById('test-data-processing').addEventListener('click', async () => {
            log('Testing data processing...', 'info');
            
            try {
                // First ensure we have player data
                if (!state.playerData || state.playerData.length === 0) {
                    log('Loading player data first...', 'info');
                    await weekDataManager.initializeWeeklyData();
                }
                
                if (!state.playerData || state.playerData.length === 0) {
                    log('No player data available for testing', 'warning');
                    recordTestResult('Data Processing Test', false, 'No player data available');
                    return;
                }
                
                // Save reference to allPlayersData
                const originalAllPlayersData = state.allPlayersData;
                
                // Copy player data to allPlayersData for processing
                state.allPlayersData = [...state.playerData];
                
                // Reset displayData
                state.displayData = [];
                
                // Process the data
                dataProcessing.processPlayerData();
                
                // Check if displayData was populated
                const displayDataPopulated = state.displayData && state.displayData.length > 0;
                recordTestResult(
                    'Process Player Data', 
                    displayDataPopulated,
                    displayDataPopulated ? `Processed ${state.displayData.length} players` : 'No players processed'
                );
                
                // Check if ranking was added
                if (displayDataPopulated) {
                    const hasRanking = state.displayData[0].rank !== undefined;
                    recordTestResult(
                        'Player Ranking', 
                        hasRanking,
                        hasRanking ? 'Players have ranking' : 'Players missing ranking'
                    );
                    
                    // Log processed data details
                    state.displayData.slice(0, 3).forEach(player => {
                        const playerName = player.PLAYER || player.Name || 'Unknown';
                        log(`Processed: Rank ${player.rank}, ${playerName}, Score: ${player.TOTAL_SCORE}`, 'info');
                    });
                }
                
                // Restore original allPlayersData
                state.allPlayersData = originalAllPlayersData;
                
                log('Data processing test completed', 'info');
            } catch (error) {
                log(`Data processing test error: ${error.message}`, 'error');
                console.error(error);
                recordTestResult('Data Processing Test', false, `Error: ${error.message}`);
            }
        });
        
        // UI Updates test
        document.getElementById('test-ui-updates').addEventListener('click', async () => {
            log('Testing UI updates...', 'info');
            
            try {
                // Create mock DOM elements
                const mockElements = {
                    statTotalPlayers: document.createElement('div'),
                    statTotalScore: document.createElement('div'),
                    statTotalChests: document.createElement('div'),
                    statAvgScore: document.createElement('div'),
                    statAvgChests: document.createElement('div'),
                    rankingTableBody: document.createElement('div')
                };
                
                // Add mock elements to body
                Object.entries(mockElements).forEach(([key, element]) => {
                    element.id = key;
                    document.body.appendChild(element);
                });
                
                log('Created mock UI elements', 'info');
                
                // Save original DOM elements
                const originalElements = {...dom.elements};
                
                // Set mock elements
                dom.elements = {...dom.elements, ...mockElements};
                
                // Ensure we have display data
                if (!state.displayData || state.displayData.length === 0) {
                    // If we have player data, copy it to displayData
                    if (state.playerData && state.playerData.length > 0) {
                        state.displayData = [...state.playerData];
                        
                        // Process the data to ensure it has proper structure
                        dataProcessing.addRankingToPlayers(state.displayData);
                    } else {
                        log('No display data available for testing', 'warning');
                        recordTestResult('UI Updates Test', false, 'No display data available');
                        
                        // Clean up
                        Object.values(mockElements).forEach(element => {
                            document.body.removeChild(element);
                        });
                        dom.elements = originalElements;
                        
                        return;
                    }
                }
                
                // Update the UI
                uiUpdates.updateDashboardStatistics();
                
                // Check if statistics were updated
                const statsUpdated = mockElements.statTotalPlayers.textContent !== '';
                recordTestResult(
                    'Dashboard Statistics Update', 
                    statsUpdated,
                    statsUpdated ? 'Dashboard statistics updated' : 'Dashboard statistics not updated'
                );
                
                // Try to update ranking table
                uiUpdates.updateRankingTable();
                
                // Check if table was populated
                const tableUpdated = mockElements.rankingTableBody.innerHTML !== '';
                recordTestResult(
                    'Ranking Table Update', 
                    tableUpdated,
                    tableUpdated ? 'Ranking table updated' : 'Ranking table not updated'
                );
                
                // Clean up
                Object.values(mockElements).forEach(element => {
                    document.body.removeChild(element);
                });
                
                // Restore original elements
                dom.elements = originalElements;
                log('Restored original DOM elements', 'info');
                
                log('UI updates test completed', 'info');
            } catch (error) {
                log(`UI updates test error: ${error.message}`, 'error');
                console.error(error);
                recordTestResult('UI Updates Test', false, `Error: ${error.message}`);
                
                // Clean up in case of error
                const mockElementIds = ['statTotalPlayers', 'statTotalScore', 'statTotalChests', 'statAvgScore', 'statAvgChests', 'rankingTableBody'];
                mockElementIds.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        document.body.removeChild(element);
                    }
                });
            }
        });
        
        // Run all tests
        document.getElementById('run-all-tests').addEventListener('click', async () => {
            log('Running all tests...', 'info');
            
            // Reset test results
            testResults.passed = 0;
            testResults.failed = 0;
            testResults.total = 0;
            
            // Clear logs
            logsElement.innerHTML = '';
            
            // Run each test in sequence
            const testButtons = [
                'test-config',
                'test-file-exists',
                'test-weeks-json',
                'test-rules-csv',
                'test-week-data',
                'test-week-switching',
                'test-missing-file',
                'test-invalid-data',
                'test-fallback-data',
                'test-week-selector',
                'test-data-processing',
                'test-ui-updates'
            ];
            
            for (const buttonId of testButtons) {
                log(`Running test: ${buttonId}`, 'info');
                document.getElementById(buttonId).click();
                
                // Small pause between tests
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            
            log('All tests completed', 'info');
        });
        
        // Clear logs
        document.getElementById('clear-logs').addEventListener('click', () => {
            logsElement.innerHTML = '';
        });
        
        // Initial log
        log('Data loading test initialized. Click buttons above to run tests.', 'info');
    </script>
</body>
</html> 